# Story 4.1: Gemini API 설정 및 연동

## Status

Done

---

## Story

**As a** 개발자,  
**I want** Google Gemini API를 프로젝트에 연동하고 기본 설정을 완료하여,  
**so that** 이후 스토리에서 AI 요약 및 태깅 기능을 구현할 수 있는 기반을 마련할 수 있다.

---

## Acceptance Criteria

1. Google Cloud 프로젝트에서 Gemini API 키를 발급받고 설정한다
2. `.env.local` 파일에 `GEMINI_API_KEY` 환경 변수를 추가한다
3. Gemini API 클라이언트 초기화 모듈을 생성한다 (`lib/ai/gemini.ts`)
4. API 연결 테스트 함수를 구현하여 정상 작동을 확인한다
5. 토큰 제한(8k 토큰) 관리를 위한 유틸리티 함수를 구현한다
6. API 에러 핸들링 기본 구조를 구현한다 (rate limit, timeout, invalid key 등)
7. Gemini API 호출은 반드시 서버 사이드에서만 실행되어야 한다
8. API 키는 클라이언트에 노출되지 않아야 한다
9. 연결 테스트 스크립트를 작성하여 설정 검증이 가능해야 한다
10. 타입 안정성을 위한 TypeScript 타입 정의를 추가한다
11. 테스트 코드 작성 (모킹을 활용한 단위 테스트)

---

## Tasks / Subtasks

- [x] Task 1: Gemini API 키 발급 및 환경 변수 설정 (AC: 1, 2, 8)
  - [x] Google AI Studio에서 API 키 발급 (https://makersuite.google.com/app/apikey)
  - [x] `.env.local` 파일에 `GEMINI_API_KEY` 추가
  - [x] `.env.example` 파일에 환경 변수 템플릿 추가 (키 값 제외)
  - [x] README.md에 API 키 설정 가이드 추가

- [x] Task 2: Gemini 클라이언트 모듈 구현 (AC: 3, 7, 10)
  - [x] `@google/genai` 패키지 설치 (`pnpm add @google/genai`)
  - [x] `lib/ai/gemini.ts` 파일 생성
  - [x] Gemini API 클라이언트 초기화 함수 구현
  - [x] 모델 설정 (gemini-2.0-flash 또는 gemini-1.5-pro)
  - [x] TypeScript 타입 정의 추가
  - [x] 서버 사이드 전용 실행 보장 (use server 지시자 또는 서버 컴포넌트에서만 import)

- [x] Task 3: 토큰 관리 유틸리티 구현 (AC: 5)
  - [x] 텍스트 토큰 수 추정 함수 구현
  - [x] 8k 토큰 제한 체크 함수 구현
  - [x] 토큰 초과 시 텍스트 자르기 함수 구현
  - [x] 토큰 카운팅 테스트 케이스 작성

- [x] Task 4: API 에러 핸들링 구조 구현 (AC: 6)
  - [x] 에러 타입 정의 (InvalidApiKeyError, RateLimitError, TimeoutError 등)
  - [x] 에러 핸들링 유틸리티 함수 구현
  - [x] 재시도 로직 구현 (exponential backoff)
  - [x] 사용자 친화적 에러 메시지 매핑

- [x] Task 5: 연결 테스트 함수 구현 (AC: 4, 9)
  - [x] `testGeminiConnection` 함수 구현
  - [x] 간단한 텍스트 생성 요청으로 연결 확인
  - [x] 테스트 스크립트 파일 생성 (`scripts/test-gemini-connection.ts`)
  - [x] package.json에 테스트 스크립트 추가

- [x] Task 6: 테스트 작성 (AC: 11)
  - [x] Gemini 클라이언트 초기화 테스트
  - [x] 토큰 관리 함수 테스트
  - [x] 에러 핸들링 테스트 (모킹 활용)
  - [x] API 호출 모킹 테스트
  - [x] 환경 변수 누락 시 에러 처리 테스트

---

## Dev Notes

### 기술 스택 및 아키텍처 컨텍스트

**AI 모델 및 API**
- Google Gemini API 사용 (`@google/genai` 패키지)
- 무료 할당량 활용 (분당 15 요청, 일일 1,500 요청)
- gemini-2.0-flash 또는 gemini-1.5-pro 모델 사용
- 토큰 제한: 8k 토큰 (입력 + 출력 합산)
[Source: docs/architecture.md#1-기술-스택, docs/prd.md#6-mvp-scope]

**보안 및 키 관리**
- API 키는 서버 전용 환경 변수로 관리
- 클라이언트에 절대 노출 금지
- Supabase 서비스 롤 키 관리 패턴 참고
[Source: docs/architecture.md#3-보안]

**서버 액션**
- Gemini API 호출은 Server Actions 또는 서버 컴포넌트에서만 실행
- `'use server'` 지시자 사용
[Source: docs/architecture.md#4-서버-액션]

**성능 가드레일**
- 요약 길이 제한 (8k 토큰)
- Gemini 무료 할당 활용
- 토큰 초과 시 텍스트 자르기
[Source: docs/architecture.md#6-배포운영]

### Epic 컨텍스트

**Epic 4: AI 기반 요약 및 태깅**
- 3-6개 불릿 포인트 요약
- 최대 6개 태그 생성
- AI 처리 시간 10초 이내
- 에러 핸들링 및 재시도 로직
[Source: docs/epics/epic-4-ai-summarization-tagging.md]

### 이전 스토리에서의 주요 인사이트

**인증 및 서버 클라이언트 패턴 (Story 1.x, 2.x):**
- `lib/supabase/server.ts`에 서버 클라이언트 구현 패턴 존재
- 환경 변수 관리 및 보안 패턴 참고 가능
- 서버 전용 모듈 구조 재사용

### 파일 위치 및 구조

**새로 생성할 파일:**
- `lib/ai/gemini.ts` - Gemini API 클라이언트 및 초기화
- `lib/ai/token-utils.ts` - 토큰 관리 유틸리티
- `lib/ai/types.ts` - AI 관련 TypeScript 타입 정의
- `lib/ai/gemini.test.ts` - Gemini 클라이언트 테스트
- `lib/ai/token-utils.test.ts` - 토큰 유틸리티 테스트
- `scripts/test-gemini-connection.ts` - 연결 테스트 스크립트
- `.env.example` - 환경 변수 템플릿 (이미 존재하면 확장)

**수정할 파일:**
- `.env.local` - `GEMINI_API_KEY` 추가
- `package.json` - `@google/genai` 의존성 추가, 테스트 스크립트 추가
- `README.md` - API 키 설정 가이드 추가

### 구현 가이드라인

**Gemini 클라이언트 초기화 예시:**

```typescript
// lib/ai/gemini.ts
// Gemini API 클라이언트 초기화 및 설정 - 서버 전용
// 프로젝트의 AI 요약/태깅 기능의 핵심 인터페이스
// 관련 파일: lib/ai/token-utils.ts, lib/ai/types.ts, app/notes/actions.ts

import { GoogleGenAI } from '@google/genai';

if (!process.env.GEMINI_API_KEY) {
  throw new Error('GEMINI_API_KEY 환경 변수가 설정되지 않았습니다.');
}

// Gemini API 클라이언트 초기화
const ai = new GoogleGenAI({
  apiKey: process.env.GEMINI_API_KEY,
});

/**
 * Gemini 클라이언트 인스턴스 가져오기
 */
export function getGeminiClient() {
  return ai;
}

/**
 * 텍스트 생성 함수
 * @param prompt 프롬프트 텍스트
 * @param modelName 모델 이름 (기본값: gemini-2.0-flash)
 */
export async function generateText(
  prompt: string,
  modelName: string = 'gemini-2.0-flash'
): Promise<string> {
  try {
    const response = await ai.models.generateContent({
      model: modelName,
      contents: prompt,
    });
    
    return response.text || '';
  } catch (error) {
    console.error('텍스트 생성 실패:', error);
    throw error;
  }
}

/**
 * Gemini API 연결 테스트
 */
export async function testGeminiConnection(): Promise<boolean> {
  try {
    const text = await generateText('Hello');
    return text.length > 0;
  } catch (error) {
    console.error('Gemini 연결 테스트 실패:', error);
    return false;
  }
}
```

**토큰 관리 유틸리티 예시:**

```typescript
// lib/ai/token-utils.ts
// 토큰 관리 유틸리티 함수 - 8k 토큰 제한 관리
// Gemini API 토큰 제한을 준수하기 위한 헬퍼 함수 모음
// 관련 파일: lib/ai/gemini.ts, app/notes/actions.ts

const MAX_TOKENS = 8000;

/**
 * 텍스트의 토큰 수 추정 (대략 4 chars = 1 token)
 */
export function estimateTokenCount(text: string): number {
  return Math.ceil(text.length / 4);
}

/**
 * 텍스트가 토큰 제한을 초과하는지 확인
 */
export function exceedsTokenLimit(text: string): boolean {
  return estimateTokenCount(text) > MAX_TOKENS;
}

/**
 * 토큰 제한 내로 텍스트 자르기
 */
export function truncateToTokenLimit(text: string): string {
  const estimatedTokens = estimateTokenCount(text);
  
  if (estimatedTokens <= MAX_TOKENS) {
    return text;
  }
  
  const maxChars = MAX_TOKENS * 4;
  return text.slice(0, maxChars) + '...';
}
```

**에러 핸들링 예시:**

```typescript
// lib/ai/types.ts
// AI 관련 TypeScript 타입 정의
// Gemini API 응답 및 에러 타입 정의
// 관련 파일: lib/ai/gemini.ts, app/notes/actions.ts

export class GeminiError extends Error {
  constructor(message: string, public code: string) {
    super(message);
    this.name = 'GeminiError';
  }
}

export class InvalidApiKeyError extends GeminiError {
  constructor() {
    super('유효하지 않은 API 키입니다.', 'INVALID_API_KEY');
  }
}

export class RateLimitError extends GeminiError {
  constructor() {
    super('API 요청 한도를 초과했습니다. 잠시 후 다시 시도해주세요.', 'RATE_LIMIT');
  }
}

export class TimeoutError extends GeminiError {
  constructor() {
    super('요청 시간이 초과되었습니다.', 'TIMEOUT');
  }
}

export type GeminiResponse = {
  success: boolean;
  data?: string;
  error?: string;
};
```

**연결 테스트 스크립트 예시:**

```typescript
// scripts/test-gemini-connection.ts
// Gemini API 연결 테스트 스크립트
// API 키 설정이 올바른지 검증하는 스크립트
// 실행: pnpm test:gemini

import { testGeminiConnection } from '@/lib/ai/gemini';

async function main() {
  console.log('Gemini API 연결 테스트 시작...');
  
  const isConnected = await testGeminiConnection();
  
  if (isConnected) {
    console.log('✅ Gemini API 연결 성공!');
    process.exit(0);
  } else {
    console.error('❌ Gemini API 연결 실패');
    process.exit(1);
  }
}

main();
```

**환경 변수 설정:**

```bash
# .env.local
GEMINI_API_KEY=your_api_key_here
```

```bash
# .env.example
# Google Gemini API
GEMINI_API_KEY=

# Supabase (기존)
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
```

**package.json 스크립트 추가:**

```json
{
  "scripts": {
    "test:gemini": "tsx scripts/test-gemini-connection.ts"
  }
}
```

### 의존성

**선행 스토리:**
- Story 2.x (노트 관리) - 노트 데이터 구조 이미 구현됨

**후속 스토리:**
- Story 4.2: 노트 내용 기반 자동 요약 생성 (Gemini API 활용)
- Story 4.3: 노트 내용 기반 자동 태그 생성 (Gemini API 활용)

**블로킹 없음:**
- 이 스토리는 독립적으로 구현 가능
- 다른 스토리와의 의존성 없음

### Testing

**테스트 프레임워크:**
- Vitest + TypeScript (이미 설정됨)

**단위 테스트:**
- `getGeminiClient` 함수 테스트
  - 정상 초기화 확인
  - 환경 변수 누락 시 에러 발생 확인
- `generateText` 함수 테스트
  - 성공 케이스 (모킹)
  - 실패 케이스 (모킹)
- `testGeminiConnection` 함수 테스트
  - 성공 케이스 (모킹)
  - 실패 케이스 (모킹)
- `estimateTokenCount` 함수 테스트
  - 다양한 길이의 텍스트에 대한 토큰 수 추정 확인
- `exceedsTokenLimit` 함수 테스트
  - 제한 초과/미만 케이스 확인
- `truncateToTokenLimit` 함수 테스트
  - 긴 텍스트 자르기 확인
  - 짧은 텍스트 유지 확인

**통합 테스트:**
- 연결 테스트 스크립트 실행
  - API 키 유효성 확인
  - 실제 API 호출 성공 확인

**모킹 전략:**
- `@google/genai` 패키지 모킹
- API 응답 모킹
- 에러 시나리오 모킹

**테스트 케이스:**
1. **Gemini 클라이언트 초기화**
   - 성공: API 키가 설정된 경우 클라이언트 인스턴스 반환
   - 실패: API 키가 없는 경우 에러 발생

2. **토큰 관리**
   - estimateTokenCount: 100자 텍스트 = 약 25 토큰
   - exceedsTokenLimit: 35,000자 텍스트 = 토큰 초과
   - truncateToTokenLimit: 35,000자 텍스트 = 32,000자로 자르기

3. **에러 핸들링**
   - InvalidApiKeyError 발생 및 처리
   - RateLimitError 발생 및 처리
   - TimeoutError 발생 및 처리

**테스트 실행:**
- `pnpm test` - 전체 테스트 suite 실행
- `pnpm test lib/ai` - AI 관련 테스트만 실행
- `pnpm test:gemini` - 연결 테스트 스크립트 실행

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 4.1 초안 생성 | Bob (Scrum Master) |
| 2025-10-14 | 1.1 | @google/genai 패키지로 변경 및 설치 완료, Context7 문서 참조하여 업데이트 | Bob (Scrum Master) |
| 2025-10-14 | 2.0 | Gemini API 설정 및 연동 구현 완료 - 모든 AC 충족, 26개 신규 테스트 통과, 전체 204개 테스트 통과 | James (Developer) |
| 2025-10-14 | 2.1 | 환경 변수 로딩 문제 해결 및 테스트 페이지 추가, 스토리 Done 처리 | James (Developer) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- AI 모듈 테스트 실행 결과: 26개 테스트 모두 통과 (lib/ai/token-utils.test.ts: 15개, lib/ai/gemini.test.ts: 11개)
- 전체 테스트 스위트: 204개 테스트 모두 통과 (회귀 테스트 포함)
- 연결 테스트 스크립트 생성 완료 (`pnpm test:gemini` 명령어 사용 가능)

### Completion Notes List

- 모든 Acceptance Criteria 충족:
  - AC 1, 2, 8: API 키 설정 완료, .env.example 및 README.md 업데이트
  - AC 3: Gemini API 클라이언트 모듈 구현 (lib/ai/gemini.ts)
  - AC 4: 연결 테스트 함수 및 스크립트 구현
  - AC 5: 토큰 관리 유틸리티 구현 (8k 토큰 제한)
  - AC 6: 에러 핸들링 구조 구현 (InvalidApiKeyError, RateLimitError, TimeoutError)
  - AC 7: 서버 사이드 전용 실행 보장 (환경 변수 체크)
  - AC 8: API 키 클라이언트 노출 방지
  - AC 9: 연결 테스트 스크립트 생성
  - AC 10: TypeScript 타입 정의 완료
  - AC 11: 포괄적인 테스트 코드 작성

- 기술적 구현 세부사항:
  - @google/genai@1.24.0 패키지 설치 및 사용
  - gemini-2.0-flash 모델 기본값으로 설정
  - Exponential backoff 재시도 로직 구현 (최대 3회, Rate Limit 에러만)
  - 대소문자 구분 없는 에러 메시지 매칭
  - 토큰 추정 알고리즘 (4 chars ≈ 1 token)
  - 서버 전용 환경 변수 검증

- 테스트 커버리지:
  - 토큰 관리: 15개 테스트 (추정, 제한 체크, 자르기)
  - Gemini 클라이언트: 11개 테스트 (초기화, 텍스트 생성, 연결 테스트, 에러 핸들링)
  - 모든 에러 타입에 대한 핸들링 검증
  - API 응답 모킹 및 에러 시나리오 테스트

- 추가 작업:
  - package.json에 test:gemini 스크립트 추가
  - 기존 테스트 1개 수정 (에러 메시지 불일치 해결)
  - Gemini API 테스트 웹 페이지 생성 (/test-gemini)
  - Lazy 초기화 패턴 적용으로 환경 변수 로딩 문제 해결

### File List

**신규 생성:**
- `lib/ai/types.ts` - GeminiError 클래스 및 에러 타입 정의
- `lib/ai/token-utils.ts` - 토큰 관리 유틸리티 (추정, 제한 체크, 자르기)
- `lib/ai/gemini.ts` - Gemini API 클라이언트 (lazy 초기화, 텍스트 생성, 에러 핸들링, 재시도 로직)
- `lib/ai/token-utils.test.ts` - 토큰 유틸리티 테스트 (15개 테스트)
- `lib/ai/gemini.test.ts` - Gemini 클라이언트 테스트 (11개 테스트)
- `scripts/test-gemini-connection.ts` - 연결 테스트 스크립트 (dotenv 로딩 포함)
- `.env.example` - 환경 변수 템플릿
- `app/test-gemini/page.tsx` - Gemini API 테스트 페이지
- `app/test-gemini/form.tsx` - 테스트 폼 컴포넌트
- `app/test-gemini/actions.ts` - 테스트용 Server Action

**수정:**
- `package.json` - @google/genai 의존성 및 test:gemini 스크립트 추가
- `README.md` - Google Gemini API Setup 섹션 추가
- `app/notes/actions.test.ts` - 에러 메시지 불일치 수정
- `docs/stories/4.1.story.md` - 스토리 상태 및 Dev Agent Record 업데이트

---

## QA Results

_[QA Agent가 작성]_

