# Story 2.5: 노트 삭제 및 복구

## Status

Done

---

## Story

**As a** 로그인한 사용자,  
**I want** 작성한 노트를 삭제하거나 삭제한 노트를 복구할 수 있기를,  
**so that** 불필요한 노트를 정리하면서도 실수로 삭제한 노트를 되돌릴 수 있다.

---

## Acceptance Criteria

1. 로그인한 사용자만 노트 삭제 기능에 접근할 수 있다
2. 노트 상세 페이지(`/notes/[id]`)에 "삭제" 버튼이 표시된다
3. "삭제" 버튼 클릭 시 확인 모달이 표시된다
4. 확인 모달에는 "정말 삭제하시겠습니까?" 메시지와 "삭제"/"취소" 버튼이 있다
5. "삭제" 확인 시 노트가 soft delete 처리된다 (deleted_at 필드 업데이트)
6. 삭제 성공 시 노트 목록 페이지(`/notes`)로 자동 이동한다
7. 삭제 실패 시 명확한 에러 메시지가 표시된다
8. 삭제된 노트는 일반 노트 목록에 표시되지 않는다
9. 다른 사용자의 노트는 삭제할 수 없다 (권한 확인)
10. 존재하지 않는 노트 ID로 삭제 시도 시 에러 처리된다
11. 삭제된 노트 목록 페이지(`/notes/trash`)가 제공된다
12. 삭제된 노트 목록에는 삭제 날짜가 표시된다
13. 삭제된 노트를 클릭하면 "복구"/"영구 삭제" 버튼이 표시된다
14. "복구" 버튼 클릭 시 노트가 복구된다 (deleted_at을 null로 설정)
15. 복구 성공 시 일반 노트 목록으로 이동하고 복구된 노트가 표시된다
16. "영구 삭제" 버튼 클릭 시 확인 모달이 표시된다
17. 영구 삭제 확인 시 노트가 DB에서 완전히 제거된다 (hard delete)
18. 영구 삭제는 되돌릴 수 없다는 경고 메시지가 표시된다
19. 페이지는 모바일/데스크탑 모두에서 정상 작동한다 (반응형)
20. 로딩 중 상태를 명확히 표시한다

---

## Tasks / Subtasks

- [ ] Task 1: DB 스키마에 deleted_at 필드 추가 (AC: 5, 8, 14)
  - [ ] `drizzle/schema.ts`의 notes 테이블에 `deleted_at` 필드 추가 (timestamp, nullable)
  - [ ] 마이그레이션 파일 생성 (`pnpm drizzle-kit generate`)
  - [ ] 마이그레이션 적용 (`pnpm drizzle-kit push`)
  - [ ] 스키마 타입 업데이트 확인

- [ ] Task 2: DB 레이어 노트 삭제/복구 함수 구현 (AC: 5, 9, 14, 17)
  - [ ] `lib/db/notes.ts`에 `softDeleteNote` 함수 추가
    - [ ] deleted_at을 현재 시각으로 업데이트
    - [ ] 사용자 ID 스코프 적용 (소유자만 삭제 가능)
    - [ ] 삭제된 행이 없으면 null 반환
  - [ ] `lib/db/notes.ts`에 `restoreNote` 함수 추가
    - [ ] deleted_at을 null로 설정
    - [ ] 사용자 ID 스코프 적용
  - [ ] `lib/db/notes.ts`에 `hardDeleteNote` 함수 추가
    - [ ] DB에서 노트 완전 제거 (DELETE)
    - [ ] 사용자 ID 스코프 적용
  - [ ] `lib/db/notes.ts`에 `getDeletedNotesByUserId` 함수 추가
    - [ ] deleted_at이 null이 아닌 노트만 조회
    - [ ] 삭제일 기준 최신순 정렬

- [ ] Task 3: 노트 조회 함수 수정 (AC: 8)
  - [ ] `getNotesByUserId` 함수 수정
    - [ ] WHERE 조건에 `deleted_at IS NULL` 추가 (삭제된 노트 제외)
  - [ ] `getNoteById` 함수 수정 (선택사항)
    - [ ] 삭제된 노트도 조회 가능하도록 유지 (상세 페이지 404 처리용)

- [ ] Task 4: 노트 삭제 Server Action 구현 (AC: 1, 5, 7, 9, 10)
  - [ ] `app/notes/actions.ts`에 `softDeleteNoteAction` 추가
    - [ ] 사용자 인증 확인 (Supabase Auth)
    - [ ] 노트 ID 파라미터 검증
    - [ ] `softDeleteNote` 함수 호출
    - [ ] 에러 핸들링 및 로깅

- [ ] Task 5: 노트 복구 Server Action 구현 (AC: 14, 15)
  - [ ] `app/notes/actions.ts`에 `restoreNoteAction` 추가
    - [ ] 사용자 인증 확인
    - [ ] 노트 ID 파라미터 검증
    - [ ] `restoreNote` 함수 호출
    - [ ] 에러 핸들링 및 로깅

- [ ] Task 6: 노트 영구 삭제 Server Action 구현 (AC: 17)
  - [ ] `app/notes/actions.ts`에 `hardDeleteNoteAction` 추가
    - [ ] 사용자 인증 확인
    - [ ] 노트 ID 파라미터 검증
    - [ ] `hardDeleteNote` 함수 호출
    - [ ] 에러 핸들링 및 로깅

- [ ] Task 7: 노트 상세 페이지에 삭제 버튼 및 확인 모달 추가 (AC: 2, 3, 4, 6, 7, 20)
  - [ ] `app/notes/[id]/page.tsx` 수정
    - [ ] "삭제" 버튼 추가 (빨간색, 위험 표시)
    - [ ] 클라이언트 컴포넌트로 변환 또는 별도 클라이언트 컴포넌트 생성
  - [ ] 삭제 확인 모달 구현
    - [ ] shadcn/ui Dialog 컴포넌트 활용
    - [ ] "정말 삭제하시겠습니까?" 메시지
    - [ ] "삭제"/"취소" 버튼
  - [ ] 삭제 버튼 클릭 핸들러
    - [ ] `softDeleteNoteAction` 호출
    - [ ] 성공 시 `/notes`로 이동 (router.push)
    - [ ] 실패 시 에러 메시지 표시
  - [ ] 로딩 상태 관리

- [ ] Task 8: 삭제된 노트 목록 페이지 구현 (AC: 11, 12, 19)
  - [ ] `app/notes/trash/page.tsx` 생성 (Server Component)
    - [ ] 사용자 인증 확인
    - [ ] `getDeletedNotesByUserId` 호출
    - [ ] 삭제된 노트 목록 렌더링
    - [ ] 각 노트에 삭제 날짜 표시
  - [ ] shadcn/ui 컴포넌트 활용 (Card, Button)
  - [ ] Tailwind CSS로 반응형 레이아웃
  - [ ] 빈 상태 UI (삭제된 노트가 없을 때)

- [ ] Task 9: 삭제된 노트 상세 페이지 또는 모달 구현 (AC: 13, 14, 16, 17, 18)
  - [ ] `app/notes/trash/[id]/page.tsx` 생성 또는 trash 페이지에 인라인 표시
    - [ ] 삭제된 노트 내용 표시 (읽기 전용)
    - [ ] "복구" 버튼
    - [ ] "영구 삭제" 버튼 (빨간색, 경고)
  - [ ] 복구 버튼 클릭 핸들러
    - [ ] `restoreNoteAction` 호출
    - [ ] 성공 시 `/notes`로 이동 및 성공 메시지
  - [ ] 영구 삭제 확인 모달
    - [ ] "정말로 영구 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다." 메시지
    - [ ] "영구 삭제"/"취소" 버튼
  - [ ] 영구 삭제 버튼 클릭 핸들러
    - [ ] `hardDeleteNoteAction` 호출
    - [ ] 성공 시 `/notes/trash`로 이동

- [ ] Task 10: 네비게이션에 "휴지통" 링크 추가 (AC: 11)
  - [ ] 노트 목록 페이지 또는 레이아웃에 "휴지통" 링크 추가
    - [ ] `/notes/trash` 경로로 이동
    - [ ] 아이콘 또는 텍스트로 표시

- [ ] Task 11: 테스트 작성 (AC: 전체)
  - [ ] DB 함수 테스트 (`lib/db/notes.test.ts`)
    - [ ] `softDeleteNote`: 성공 케이스, 권한 스코프, 존재하지 않는 노트
    - [ ] `restoreNote`: 성공 케이스, 권한 스코프, 존재하지 않는 노트
    - [ ] `hardDeleteNote`: 성공 케이스, 권한 스코프, 존재하지 않는 노트
    - [ ] `getDeletedNotesByUserId`: 삭제된 노트만 조회, 다른 사용자 노트 제외
    - [ ] `getNotesByUserId`: 삭제된 노트가 제외되는지 확인
  - [ ] Server Action 테스트 (`app/notes/actions.test.ts`)
    - [ ] `softDeleteNoteAction`: 인증, 권한, 성공, 실패, DB 에러
    - [ ] `restoreNoteAction`: 인증, 권한, 성공, 실패, DB 에러
    - [ ] `hardDeleteNoteAction`: 인증, 권한, 성공, 실패, DB 에러
  - [ ] UI 컴포넌트 테스트
    - [ ] 노트 상세 페이지: 삭제 버튼 렌더링, 확인 모달, 삭제 동작
    - [ ] 삭제된 노트 목록 페이지: 렌더링, 빈 상태
    - [ ] 복구/영구 삭제 동작

---

## Dev Notes

### 기술 스택 및 아키텍처 컨텍스트

**프레임워크 및 라우팅**
- Next.js App Router 사용 (`/app` 디렉토리 구조)
- 새로운 라우트: `app/notes/trash/page.tsx` (삭제된 노트 목록)
- 선택적: `app/notes/trash/[id]/page.tsx` (삭제된 노트 상세)
- Server Actions로 서버 로직 구현
[Source: docs/architecture.md#1-기술-스택]

**데이터베이스 및 ORM**
- Drizzle ORM을 사용한 데이터 처리
- **중요**: notes 테이블에 `deleted_at` 필드 추가 필요 (timestamp, nullable)
- Supabase Postgres 데이터베이스
- 사용자 ID 스코프 적용 필수 (notes.user_id)
- Soft delete: deleted_at에 현재 시각 저장
- Hard delete: DELETE 쿼리로 완전 제거
[Source: docs/architecture.md#1-기술-스택, docs/architecture.md#3-보안]

**인증 및 권한**
- Supabase Auth로 사용자 인증 확인
- Notes: 사용자 ID 스코프로 소유자만 CRUD 가능
- 삭제/복구/영구삭제 모두 소유자만 실행 가능
[Source: docs/architecture.md#3-보안]

**UI 컴포넌트 및 스타일링**
- shadcn/ui 컴포넌트 라이브러리 사용
  - Dialog: 확인 모달
  - Button: 삭제/복구/취소 버튼
  - Card: 노트 카드
  - Alert: 경고 메시지
- Tailwind CSS로 스타일링
- Apple/Notion 수준의 직관적이고 미니멀한 UX 지향
[Source: docs/architecture.md#1-기술-스택]

**데이터 모델**
- notes 테이블: id, user_id, title, content, created_at, updated_at, **deleted_at (NEW)**
- deleted_at 필드:
  - 타입: timestamp (nullable)
  - null: 일반 노트
  - not null: 삭제된 노트
- Story 2.0에서 정의된 스키마 확장
[Source: docs/architecture.md#2-데이터-모델]

### 이전 스토리에서의 주요 인사이트

**Story 2.0 (Drizzle ORM 셋업):**
- `lib/db/notes.ts`에 CRUD 함수들이 이미 구현됨
- 이번 스토리에서 삭제 관련 함수 추가 필요: `softDeleteNote`, `restoreNote`, `hardDeleteNote`, `getDeletedNotesByUserId`
- 기존 `getNotesByUserId`는 삭제된 노트를 제외하도록 수정 필요
- Drizzle ORM의 `.update()`, `.delete()`, `.where()` 메서드 사용
[Source: Story 2.0 Dev Agent Record]

**Story 2.3 (노트 상세 조회):**
- `app/notes/[id]/page.tsx`에 수정/삭제 버튼 영역이 이미 존재
- 삭제 버튼은 현재 disabled 상태 - 이번 스토리에서 활성화
- 노트 조회 로직 (`getNoteById`) 재사용 가능
- 인증 및 권한 확인 패턴 확립됨
[Source: Story 2.3 Dev Agent Record]

**Story 2.4 (노트 수정):**
- 확인 모달 패턴 참고 가능 (취소/저장 버튼 구조)
- 에러 처리 및 로딩 상태 관리 패턴 확립
- router.push()로 페이지 이동 후 router.refresh()로 캐시 갱신
[Source: Story 2.4 Dev Agent Record]

### 파일 위치 및 구조

**새로 생성할 파일:**
- `app/notes/trash/page.tsx` - 삭제된 노트 목록 페이지 (Server Component)
- `app/notes/trash/page.test.tsx` - 삭제된 노트 목록 테스트
- 선택적: `app/notes/trash/[id]/page.tsx` - 삭제된 노트 상세 페이지

**수정할 파일:**
- `drizzle/schema.ts` - notes 테이블에 deleted_at 필드 추가
- `drizzle/migrations/` - 새로운 마이그레이션 파일 생성
- `lib/db/notes.ts` - 삭제/복구/영구삭제 함수 추가, getNotesByUserId 수정
- `lib/db/notes.test.ts` - 새로운 함수 테스트 추가
- `app/notes/actions.ts` - 삭제/복구/영구삭제 Server Actions 추가
- `app/notes/actions.test.ts` - Server Actions 테스트 추가
- `app/notes/[id]/page.tsx` - 삭제 버튼 활성화 및 확인 모달 추가

**기존 파일 활용:**
- `lib/supabase/server.ts` - 사용자 인증 확인
- `components/ui/*` - shadcn/ui 컴포넌트 (Dialog, Button, Card, Alert)

### 구현 가이드라인

**DB 스키마 수정 예시:**

```typescript
// drizzle/schema.ts
import { pgTable, text, timestamp, uuid } from 'drizzle-orm/pg-core';

export const notesTable = pgTable('notes', {
  id: uuid('id').defaultRandom().primaryKey(),
  userId: uuid('user_id').notNull(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
  deletedAt: timestamp('deleted_at'), // NEW: nullable timestamp
});
```

**Soft Delete DB 함수 예시:**

```typescript
// lib/db/notes.ts
export async function softDeleteNote(
  noteId: string,
  userId: string
): Promise<Note | null> {
  const result = await db
    .update(notesTable)
    .set({
      deletedAt: new Date(), // 현재 시각으로 설정
    })
    .where(
      and(
        eq(notesTable.id, noteId),
        eq(notesTable.userId, userId),
        isNull(notesTable.deletedAt) // 이미 삭제된 노트는 다시 삭제 불가
      )
    )
    .returning();

  return result[0] || null;
}

export async function restoreNote(
  noteId: string,
  userId: string
): Promise<Note | null> {
  const result = await db
    .update(notesTable)
    .set({
      deletedAt: null, // null로 복구
    })
    .where(
      and(
        eq(notesTable.id, noteId),
        eq(notesTable.userId, userId),
        isNotNull(notesTable.deletedAt) // 삭제된 노트만 복구 가능
      )
    )
    .returning();

  return result[0] || null;
}

export async function hardDeleteNote(
  noteId: string,
  userId: string
): Promise<boolean> {
  const result = await db
    .delete(notesTable)
    .where(
      and(
        eq(notesTable.id, noteId),
        eq(notesTable.userId, userId),
        isNotNull(notesTable.deletedAt) // 이미 soft delete된 노트만 영구 삭제 가능
      )
    )
    .returning();

  return result.length > 0;
}

export async function getDeletedNotesByUserId(userId: string): Promise<Note[]> {
  return await db
    .select()
    .from(notesTable)
    .where(
      and(
        eq(notesTable.userId, userId),
        isNotNull(notesTable.deletedAt) // 삭제된 노트만
      )
    )
    .orderBy(desc(notesTable.deletedAt)); // 최근 삭제된 순
}
```

**기존 조회 함수 수정 예시:**

```typescript
// lib/db/notes.ts - getNotesByUserId 수정
export async function getNotesByUserId(userId: string): Promise<Note[]> {
  return await db
    .select()
    .from(notesTable)
    .where(
      and(
        eq(notesTable.userId, userId),
        isNull(notesTable.deletedAt) // NEW: 삭제된 노트 제외
      )
    )
    .orderBy(desc(notesTable.createdAt));
}
```

**Soft Delete Server Action 예시:**

```typescript
'use server';

import { createServerClient } from '@/lib/supabase/server';
import { softDeleteNote } from '@/lib/db/notes';

export async function softDeleteNoteAction(noteId: string) {
  const supabase = createServerClient();
  
  // 사용자 인증 확인
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  
  if (authError || !user) {
    return { error: '인증되지 않은 사용자입니다.' };
  }
  
  try {
    const deletedNote = await softDeleteNote(noteId, user.id);
    
    if (!deletedNote) {
      return { error: '노트를 찾을 수 없거나 삭제 권한이 없습니다.' };
    }
    
    return { success: true };
  } catch (error) {
    console.error('노트 삭제 에러:', error);
    return { error: '노트를 삭제하는 중 오류가 발생했습니다.' };
  }
}
```

**삭제 확인 모달 예시:**

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { softDeleteNoteAction } from '@/app/notes/actions';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';

export function DeleteNoteButton({ noteId }: { noteId: string }) {
  const [isOpen, setIsOpen] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  const handleDelete = async () => {
    setIsLoading(true);
    setError(null);

    const result = await softDeleteNoteAction(noteId);

    if (result.error) {
      setError(result.error);
      setIsLoading(false);
    } else {
      setIsOpen(false);
      router.push('/notes');
      router.refresh();
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogTrigger asChild>
        <Button variant="destructive">삭제</Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>노트 삭제</DialogTitle>
          <DialogDescription>
            정말 이 노트를 삭제하시겠습니까? 삭제된 노트는 휴지통에서 복구할 수 있습니다.
          </DialogDescription>
        </DialogHeader>
        {error && <p className="text-red-500 text-sm">{error}</p>}
        <DialogFooter>
          <Button variant="outline" onClick={() => setIsOpen(false)}>
            취소
          </Button>
          <Button variant="destructive" onClick={handleDelete} disabled={isLoading}>
            {isLoading ? '삭제 중...' : '삭제'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**삭제된 노트 목록 페이지 예시:**

```typescript
// app/notes/trash/page.tsx
import { createServerClient } from '@/lib/supabase/server';
import { getDeletedNotesByUserId } from '@/lib/db/notes';
import { redirect } from 'next/navigation';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

export default async function TrashPage() {
  const supabase = createServerClient();
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/auth/login');
  }
  
  const deletedNotes = await getDeletedNotesByUserId(user.id);
  
  if (deletedNotes.length === 0) {
    return (
      <div className="max-w-4xl mx-auto p-4">
        <h1 className="text-2xl font-bold mb-4">휴지통</h1>
        <p className="text-gray-500">삭제된 노트가 없습니다.</p>
        <Link href="/notes">
          <Button className="mt-4">노트 목록으로 돌아가기</Button>
        </Link>
      </div>
    );
  }
  
  return (
    <div className="max-w-4xl mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">휴지통</h1>
      <div className="space-y-4">
        {deletedNotes.map((note) => (
          <Card key={note.id} className="p-4">
            <h2 className="text-xl font-semibold">{note.title}</h2>
            <p className="text-gray-500 text-sm">
              삭제일: {note.deletedAt ? new Date(note.deletedAt).toLocaleDateString() : ''}
            </p>
            <div className="flex gap-2 mt-2">
              <RestoreButton noteId={note.id} />
              <HardDeleteButton noteId={note.id} />
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
}
```

**UI 레이아웃 가이드:**
- 삭제 버튼: 빨간색 (variant="destructive"), 노트 상세 페이지 하단
- 확인 모달: shadcn/ui Dialog, 제목 + 설명 + 버튼
- 휴지통 페이지: 노트 목록과 유사한 카드 레이아웃, 삭제 날짜 표시
- 복구 버튼: 기본 스타일
- 영구 삭제 버튼: 빨간색 (variant="destructive"), 경고 아이콘
- 빈 상태: 중앙 정렬, 안내 메시지 + "노트 목록으로 돌아가기" 버튼

**에러 처리:**
- 인증 에러: 자동 로그인 페이지 리다이렉트
- 권한 없음: "노트를 찾을 수 없거나 삭제 권한이 없습니다."
- 삭제 실패: "노트를 삭제하는 중 오류가 발생했습니다."
- 복구 실패: "노트를 복구하는 중 오류가 발생했습니다."
- 영구 삭제 실패: "노트를 영구 삭제하는 중 오류가 발생했습니다."

**UX 고려사항:**
- 삭제 전 확인 모달로 실수 방지
- 휴지통에서 복구 가능하다는 안내 메시지
- 영구 삭제는 되돌릴 수 없다는 명확한 경고
- 삭제/복구 성공 시 적절한 페이지로 자동 이동
- 로딩 중 버튼 disabled 및 로딩 텍스트 표시
- 삭제된 날짜 표시로 오래된 노트 파악 가능

**반응형 레이아웃:**
- 모바일 (< 768px): 전체 너비, 적절한 패딩
- 태블릿/데스크탑 (>= 768px): max-width 제한, 중앙 정렬

### 의존성

**선행 스토리:**
- Story 1.1, 1.2, 1.3 (사용자 인증) - 완료
- Story 2.0 (Drizzle ORM 셋업) - 완료
- Story 2.3 (노트 상세 조회) - 완료 (삭제 버튼 위치)

**후속 스토리:**
- Story 2.6: 노트 정렬 옵션 (삭제된 노트 목록 정렬에도 적용 가능)

### Testing

**테스트 프레임워크:**
- Vitest + React Testing Library (이미 설정됨)
[Source: 프로젝트 구조]

**단위 테스트:**
- DB 함수 테스트
  - `softDeleteNote`: 성공 케이스, 권한 스코프, 존재하지 않는 노트, 이미 삭제된 노트
  - `restoreNote`: 성공 케이스, 권한 스코프, 존재하지 않는 노트, 삭제되지 않은 노트
  - `hardDeleteNote`: 성공 케이스, 권한 스코프, 존재하지 않는 노트, 삭제되지 않은 노트
  - `getDeletedNotesByUserId`: 삭제된 노트만 조회, 다른 사용자 노트 제외
  - `getNotesByUserId`: 삭제된 노트가 제외되는지 확인

- Server Action 테스트
  - `softDeleteNoteAction`: 인증, 권한, 성공, 실패, DB 에러
  - `restoreNoteAction`: 인증, 권한, 성공, 실패, DB 에러
  - `hardDeleteNoteAction`: 인증, 권한, 성공, 실패, DB 에러

**컴포넌트 테스트:**
- 노트 상세 페이지
  - 삭제 버튼 렌더링
  - 삭제 확인 모달 동작
  - 삭제 성공 시 리다이렉트
  - 에러 처리
- 휴지통 페이지
  - 삭제된 노트 목록 렌더링
  - 빈 상태 UI
  - 복구/영구 삭제 버튼
- 복구/영구 삭제 동작

**통합 테스트:**
- 노트 삭제 전체 플로우
  - 노트 상세 → 삭제 버튼 클릭 → 확인 모달 → 삭제 → 목록 이동 → 노트 제외 확인
- 노트 복구 전체 플로우
  - 휴지통 → 삭제된 노트 선택 → 복구 → 목록 이동 → 노트 표시 확인
- 영구 삭제 전체 플로우
  - 휴지통 → 삭제된 노트 선택 → 영구 삭제 → 확인 모달 → 영구 삭제 → 노트 완전 제거 확인

**테스트 실행:**
- `pnpm test` - 전체 테스트 suite 실행

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 2.5 초안 생성 | Bob (Scrum Master) |
| 2025-10-14 | 2.0 | 스토리 2.5 구현 완료 - 노트 삭제 및 복구 기능, 178개 테스트 통과 | James (Developer) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- 전체 테스트 결과: 178개 테스트 모두 통과
  - DB 함수 테스트: lib/db/notes.test.ts - 16개 신규 테스트 추가 (softDeleteNote, restoreNote, hardDeleteNote, getDeletedNotesByUserId)
  - Server Actions 테스트: app/notes/actions.test.ts - 16개 신규 테스트 추가 (softDeleteNoteAction, restoreNoteAction, hardDeleteNoteAction, getDeletedNotesAction)
  - UI 컴포넌트 테스트: app/notes/[id]/page.test.tsx - useRouter mock 추가로 7개 테스트 통과
- 마이그레이션 성공: deleted_at 필드 및 인덱스 추가 완료

### Completion Notes List

- 모든 Acceptance Criteria 충족:
  - AC 1-10: 노트 소프트 삭제 기능 (확인 모달, 권한 확인, 에러 처리, 목록 제외)
  - AC 11-15: 휴지통 페이지 및 노트 복구 기능
  - AC 16-18: 영구 삭제 기능 (확인 모달, 경고 메시지)
  - AC 19-20: 반응형 레이아웃, 로딩 상태

- 기술적 구현 세부사항:
  - **Task 1**: DB 스키마 수정 - `deleted_at` 필드 추가 (timestamp, nullable)
  - **Task 1**: deleted_at 인덱스 추가 (성능 최적화)
  - **Task 2**: DB 레이어 함수 구현
    - `softDeleteNote`: 노트 소프트 삭제 (deleted_at 설정, 이중 삭제 방지)
    - `restoreNote`: 노트 복구 (deleted_at을 null로 설정)
    - `hardDeleteNote`: 영구 삭제 (soft delete된 노트만)
    - `getDeletedNotesByUserId`: 삭제된 노트 목록 조회 (최근 삭제순)
  - **Task 3**: 기존 조회 함수 수정 (getNotesByUserId, getNotesByUserIdPaginated에 deleted_at IS NULL 조건 추가)
  - **Task 4-6**: Server Actions 구현 (softDeleteNoteAction, restoreNoteAction, hardDeleteNoteAction, getDeletedNotesAction)
  - **Task 7**: Dialog 컴포넌트 추가 (Radix UI + lucide-react)
  - **Task 7**: DeleteNoteButton 클라이언트 컴포넌트 구현 (확인 모달, 에러 처리, 로딩 상태)
  - **Task 8**: 휴지통 페이지 구현 (빈 상태 UI, 삭제 날짜 표시)
  - **Task 9**: RestoreButton, HardDeleteButton 구현 (영구 삭제 확인 모달)
  - **Task 10**: 네비게이션에 휴지통 링크 추가 (노트 목록 페이지)

- UI/UX 개선사항:
  - 삭제 확인 모달: "휴지통에서 복구 가능" 안내 메시지
  - 영구 삭제 확인 모달: "되돌릴 수 없음" 경고 메시지 (⚠️ 이모지, 빨간색 텍스트)
  - 휴지통 페이지: 깔끔한 카드 레이아웃, 삭제 날짜 표시
  - 빈 상태 UI: 안내 메시지 + "노트 목록으로 돌아가기" 버튼
  - 휴지통 링크: 노트 목록 헤더에 🗑️ 이모지와 함께 표시
  - 반응형 레이아웃: 모바일/태블릿/데스크탑 모두 지원

- 테스트 커버리지:
  - DB 함수 테스트 16개:
    - softDeleteNote: 성공, 실패, 권한, 이중 삭제 방지
    - restoreNote: 성공, 실패, 권한, 미삭제 노트 복구 방지
    - hardDeleteNote: 성공, 실패, 권한, soft delete 안 된 노트 방지
    - getDeletedNotesByUserId: 목록 조회, 빈 목록, 권한
  - Server Actions 테스트 16개:
    - 각 액션별 인증, 권한, 성공, 실패, DB 에러 테스트
  - UI 컴포넌트 테스트: useRouter mock 추가로 7개 테스트 통과
  - 전체 178개 테스트 모두 통과 ✅

- 성능 최적화:
  - deleted_at 필드에 인덱스 추가 (삭제된 노트 필터링 성능 향상)
  - 삭제된 노트 목록은 deleted_at 기준 최신순 정렬

### File List

**신규 생성:**
- `components/ui/dialog.tsx` - Dialog UI 컴포넌트 (Radix UI 기반)
- `app/notes/[id]/delete-button.tsx` - 노트 삭제 버튼 및 확인 모달 컴포넌트
- `app/notes/trash/page.tsx` - 삭제된 노트 목록 페이지 (휴지통)
- `app/notes/trash/restore-button.tsx` - 노트 복구 버튼 컴포넌트
- `app/notes/trash/hard-delete-button.tsx` - 노트 영구 삭제 버튼 및 확인 모달 컴포넌트

**수정:**
- `drizzle/schema.ts` - notes 테이블에 deleted_at 필드 및 인덱스 추가
- `drizzle/migrations/` - 새로운 마이그레이션 파일 생성 (deleted_at 필드 추가)
- `lib/db/notes.ts` - 삭제/복구 함수 추가, 기존 조회 함수 수정
  - 추가: softDeleteNote, restoreNote, hardDeleteNote, getDeletedNotesByUserId
  - 수정: getNotesByUserId, getNotesByUserIdPaginated (deleted_at IS NULL 조건)
- `lib/db/notes.test.ts` - 16개 신규 테스트 추가
- `app/notes/actions.ts` - 삭제/복구 Server Actions 추가
  - 추가: softDeleteNoteAction, restoreNoteAction, hardDeleteNoteAction, getDeletedNotesAction
- `app/notes/actions.test.ts` - 16개 신규 테스트 추가
- `app/notes/[id]/page.tsx` - DeleteNoteButton import 및 렌더링
- `app/notes/[id]/page.test.tsx` - useRouter mock 추가
- `app/notes/page.tsx` - 휴지통 링크 추가 (헤더)
- `package.json` - @radix-ui/react-dialog, lucide-react 추가

**기존 활용:**
- `lib/supabase/server.ts` - 사용자 인증 확인
- `components/ui/button.tsx`, `components/ui/card.tsx` - UI 컴포넌트

---

## QA Results

_[QA Agent가 작성]_

