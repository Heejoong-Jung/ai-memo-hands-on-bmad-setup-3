# Story 1.3: 비밀번호 재설정

## Status

Ready for Review

---

## Story

**As a** 기존 사용자,  
**I want** 비밀번호를 잊어버렸을 때 재설정할 수 있기를,  
**so that** 계정 접근 권한을 복구하고 계속해서 AI 메모장 서비스를 사용할 수 있다.

---

## Acceptance Criteria

1. 비밀번호 찾기 페이지에서 이메일 주소를 입력할 수 있다
2. 이메일 형식 유효성 검증이 작동한다
3. 비밀번호 재설정 이메일이 발송된다
4. 이메일의 재설정 링크를 클릭하면 비밀번호 변경 페이지로 이동한다
5. 새 비밀번호는 강도 요구사항(최소 8자, 영문/숫자/특수문자 조합)을 만족해야 한다
6. 새 비밀번호 확인 입력이 일치해야 한다
7. 비밀번호 재설정 성공 시 자동으로 로그인되고 메인 페이지로 이동한다
8. 비밀번호 재설정 폼은 모바일/데스크탑 모두에서 정상 작동한다
9. 재설정 진행 중 로딩 상태를 명확히 표시한다
10. 존재하지 않는 이메일을 입력해도 보안상 같은 메시지를 표시한다

---

## Tasks / Subtasks

- [x] Task 1: 비밀번호 찾기 페이지 UI 구현 (AC: 1, 2, 8, 9, 10)
  - [x] 비밀번호 찾기 페이지 라우트 생성 (`app/auth/reset-password/page.tsx`)
  - [x] shadcn/ui Form, Input, Button 컴포넌트 재사용 (스토리 1.1에서 이미 설치됨)
  - [x] 이메일 입력 필드 with 유효성 검증 UI
  - [x] 제출 버튼 및 로딩 상태 표시
  - [x] 성공/에러 메시지 표시 영역
  - [x] 로그인 페이지로 돌아가는 링크 추가
  - [x] Tailwind를 사용한 반응형 레이아웃 구현

- [x] Task 2: 비밀번호 재설정 요청 Server Action 구현 (AC: 1, 2, 3, 9, 10)
  - [x] `app/auth/actions.ts`에 `requestPasswordReset` 함수 추가
  - [x] 이메일 형식 검증 (스토리 1.1의 유효성 검증 함수 재사용)
  - [x] Supabase Auth `resetPasswordForEmail` API 호출
  - [x] 성공 시 안내 메시지 반환 (존재하지 않는 이메일도 동일 메시지)
  - [x] 에러 핸들링 및 로깅

- [x] Task 3: 비밀번호 변경 페이지 UI 구현 (AC: 4, 5, 6, 8, 9)
  - [x] 비밀번호 변경 페이지 라우트 생성 (`app/auth/update-password/page.tsx`)
  - [x] URL에서 토큰 파라미터 파싱
  - [x] 새 비밀번호 입력 필드 with 강도 표시
  - [x] 비밀번호 확인 입력 필드
  - [x] 제출 버튼 및 로딩 상태 표시
  - [x] 에러 메시지 표시 영역
  - [x] Tailwind를 사용한 반응형 레이아웃 구현

- [x] Task 4: 비밀번호 변경 Server Action 구현 (AC: 5, 6, 7, 9)
  - [x] `app/auth/actions.ts`에 `updatePassword` 함수 추가
  - [x] 비밀번호 강도 검증 (스토리 1.1의 유효성 검증 함수 재사용)
  - [x] 비밀번호 일치 확인
  - [x] Supabase Auth `updateUser` API 호출 (비밀번호 업데이트)
  - [x] 성공 시 자동 로그인 및 메인 페이지로 리다이렉트
  - [x] 실패 시 명확한 에러 메시지 반환
  - [x] 에러 핸들링 및 로깅

- [x] Task 5: 클라이언트 사이드 폼 로직 구현 (AC: 1, 2, 5, 6, 8, 9)
  - [x] 비밀번호 찾기 폼 로직
    - [x] React Hook Form 또는 Next.js form 액션 연동
    - [x] 실시간 이메일 유효성 검증
    - [x] 제출 시 로딩 상태 관리
    - [x] 성공/에러 메시지 UI 업데이트
  - [x] 비밀번호 변경 폼 로직
    - [x] React Hook Form 또는 Next.js form 액션 연동
    - [x] 실시간 비밀번호 강도 검증
    - [x] 비밀번호 일치 확인
    - [x] 제출 시 로딩 상태 관리
    - [x] 에러 상태 UI 업데이트
    - [x] 성공 시 리다이렉션 처리

- [x] Task 6: 테스트 작성
  - [x] 이메일 유효성 검증 단위 테스트 (스토리 1.1에서 이미 작성, 재사용 확인)
  - [x] 비밀번호 강도 검증 단위 테스트 (스토리 1.1에서 이미 작성, 재사용 확인)
  - [x] 비밀번호 재설정 요청 Server Action 통합 테스트
    - [x] 성공 케이스: 유효한 이메일 → 성공 메시지 반환
    - [x] 보안 케이스: 존재하지 않는 이메일 → 동일한 성공 메시지 반환
  - [x] 비밀번호 변경 Server Action 통합 테스트
    - [x] 성공 케이스: 올바른 새 비밀번호 → 비밀번호 업데이트 성공
    - [x] 실패 케이스: 약한 비밀번호 → 에러 반환
    - [x] 실패 케이스: 비밀번호 불일치 → 에러 반환
  - [x] UI 컴포넌트 렌더링 테스트
    - [x] 비밀번호 찾기 폼 렌더링
    - [x] 비밀번호 변경 폼 렌더링
    - [x] 로그인 링크 존재 확인
  - [x] 사용자 입력 시뮬레이션 테스트
  - [x] 로딩 상태 및 에러 메시지 표시 확인

---

## Dev Notes

### 기술 스택 및 아키텍처 컨텍스트

**프레임워크 및 라우팅**
- Next.js App Router 사용 (`/app` 디렉토리 구조)
- Server Actions로 서버 로직 구현
[Source: docs/architecture.md#1-기술-스택]

**인증 시스템**
- Supabase Auth 사용
- 비밀번호 재설정은 Supabase의 `resetPasswordForEmail` 및 `updateUser` API 사용
- 재설정 링크는 이메일로 전송되며 토큰 기반 인증 처리
- 세션 관리 및 자동 갱신은 Supabase가 처리
[Source: docs/architecture.md#1-기술-스택, docs/prd.md#6-mvp-scope]

**UI 컴포넌트 및 스타일링**
- shadcn/ui 컴포넌트 라이브러리 사용 (Form, Input, Button, Card 등)
- Tailwind CSS로 스타일링
- Radix UI 기반 접근성 지원
[Source: docs/architecture.md#1-기술-스택]

**보안 및 권한**
- 클라이언트에서 직접 외부 API 호출 금지 (서버사이드에서만)
- Supabase 서비스 롤 키는 서버 전용
- 보안상 존재하지 않는 이메일을 입력해도 동일한 성공 메시지 표시 (계정 존재 여부 노출 방지)
[Source: docs/architecture.md#3-보안]

**데이터 모델**
- 사용자 정보는 Supabase Auth의 `auth.users` 테이블에 저장
- 비밀번호는 Supabase가 안전하게 해싱하여 저장
[Source: docs/architecture.md#2-데이터-모델]

### 이전 스토리(1.1, 1.2)에서의 주요 인사이트

- Supabase 클라이언트 및 서버 유틸리티 함수 이미 구현됨:
  - `lib/supabase/client.ts` (브라우저용)
  - `lib/supabase/server.ts` (서버용)
- 이메일 및 비밀번호 유효성 검증 함수 재사용 가능:
  - `lib/validations/auth.ts`의 `validateEmail` 함수
  - `lib/validations/auth.ts`의 `validatePassword` 함수
- shadcn/ui 컴포넌트 이미 설치됨: Button, Input, Label, Card
- Vitest + React Testing Library 테스트 환경 설정 완료
- 환경 변수 설정 완료 (`.env.local`)

### 파일 위치 및 구조

**예상 파일 생성 위치:**
- `/app/auth/reset-password/page.tsx` - 비밀번호 찾기 페이지 (새로 생성)
- `/app/auth/update-password/page.tsx` - 비밀번호 변경 페이지 (새로 생성)
- `/app/auth/actions.ts` - `requestPasswordReset` 및 `updatePassword` 함수 추가 (기존 파일 수정)

**재사용 가능한 파일:**
- `/lib/supabase/client.ts` - Supabase 클라이언트
- `/lib/supabase/server.ts` - Supabase 서버 클라이언트
- `/lib/validations/auth.ts` - 이메일 및 비밀번호 유효성 검증 함수
- `/components/ui/*` - 모든 UI 컴포넌트

### 구현 가이드라인

**비밀번호 재설정 플로우:**
1. 사용자가 `/auth/reset-password`에서 이메일 입력
2. `requestPasswordReset` Server Action 호출
3. Supabase가 재설정 링크를 이메일로 발송
4. 사용자가 이메일의 링크 클릭 → `/auth/update-password?token=...`로 이동
5. 사용자가 새 비밀번호 입력
6. `updatePassword` Server Action 호출
7. 비밀번호 업데이트 성공 → 자동 로그인 → 메인 페이지로 리다이렉트

**이메일 유효성 검증:**
- 스토리 1.1에서 구현한 `validateEmail` 함수 재사용
- 실시간 피드백 제공

**비밀번호 요구사항:**
- 최소 8자
- 영문자 + 숫자 + 특수문자 조합 필수
- 특수문자 예시: !@#$%^&*()_+-=[]{}|;:,.<>?
- 스토리 1.1에서 구현한 `validatePassword` 함수 재사용

**에러 처리:**
- 비밀번호 찾기:
  - 성공: "비밀번호 재설정 이메일을 발송했습니다. 이메일을 확인해주세요"
  - 보안상 존재하지 않는 이메일도 동일한 성공 메시지 표시
  - 네트워크 에러: "요청 처리 중 오류가 발생했습니다. 다시 시도해주세요"
- 비밀번호 변경:
  - 약한 비밀번호: "비밀번호는 최소 8자, 영문, 숫자, 특수문자를 포함해야 합니다"
  - 비밀번호 불일치: "비밀번호가 일치하지 않습니다"
  - 토큰 만료: "재설정 링크가 만료되었습니다. 다시 요청해주세요"
  - 네트워크 에러: "비밀번호 변경 중 오류가 발생했습니다. 다시 시도해주세요"

**UX 고려사항:**
- 로딩 중 버튼 비활성화 및 스피너 표시
- 비밀번호 찾기 성공 시 성공 메시지 표시 (페이지 이동 없음)
- 비밀번호 변경 성공 시 즉시 메인 페이지(`/`)로 리다이렉트
- 로그인 페이지로 돌아가는 링크 제공

**Supabase API 사용법:**

```typescript
// 비밀번호 재설정 이메일 요청 예시
const { data, error } = await supabase.auth.resetPasswordForEmail(
  'user@example.com',
  {
    redirectTo: 'https://yourdomain.com/auth/update-password',
  }
)

// 비밀번호 업데이트 예시
const { data, error } = await supabase.auth.updateUser({
  password: 'new-password'
})
```

### Testing

**단위 테스트:**
- 이메일 유효성 검증 함수 테스트 (스토리 1.1에서 이미 작성, 재사용 확인)
- 비밀번호 강도 검증 함수 테스트 (스토리 1.1에서 이미 작성, 재사용 확인)

**통합 테스트:**
- Server Action `requestPasswordReset` 함수 테스트
  - 성공 케이스: 유효한 이메일 → 성공 메시지 반환
  - 보안 케이스: 존재하지 않는 이메일 → 동일한 성공 메시지 반환
  - Supabase Auth API 모킹 필요
- Server Action `updatePassword` 함수 테스트
  - 성공 케이스: 올바른 새 비밀번호 → 비밀번호 업데이트 성공
  - 실패 케이스: 약한 비밀번호 → 에러 반환
  - 실패 케이스: 비밀번호 불일치 → 에러 반환
  - Supabase Auth API 모킹 필요

**컴포넌트 테스트:**
- 비밀번호 찾기 폼 렌더링 테스트
  - 이메일 입력 필드 존재 확인
  - 제출 버튼 존재 확인
  - 로그인 링크 존재 및 올바른 경로(`/auth/login`) 확인
- 비밀번호 변경 폼 렌더링 테스트
  - 새 비밀번호 입력 필드 존재 확인
  - 비밀번호 확인 입력 필드 존재 확인
  - 제출 버튼 존재 확인
- 사용자 입력 시뮬레이션 및 유효성 검증 UI 업데이트 확인
- 제출 후 로딩 상태 및 에러 메시지 표시 확인

**테스트 프레임워크:**
- Vitest (이미 설정됨)
- React Testing Library (이미 설정됨)
- Supabase Auth API 모킹을 위해 `vi.mock` 사용

**테스트 파일 위치:**
- `app/auth/reset-password/page.test.tsx` - 비밀번호 찾기 페이지 컴포넌트 테스트
- `app/auth/update-password/page.test.tsx` - 비밀번호 변경 페이지 컴포넌트 테스트
- `app/auth/actions.test.ts` - requestPasswordReset 및 updatePassword Server Action 테스트 (기존 파일 수정)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 1.3 초안 생성 | Bob (Scrum Master) |
| 2025-10-14 | 2.0 | 스토리 1.3 개발 완료 - 모든 AC 충족, 86개 테스트 통과 | James (Developer) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- 테스트 실행 중 1개 실패: "Invalid token" 에러 메시지 체크 시 대소문자 구분으로 인한 실패
- 수정: error.message.toLowerCase()로 대소문자 구분 없이 체크하도록 개선
- 모든 테스트 통과: 86개 테스트 성공

### Completion Notes List

- 비밀번호 재설정 플로우 완전 구현
- 보안을 고려한 에러 메시지 처리 (존재하지 않는 이메일도 동일한 성공 메시지)
- 실시간 비밀번호 강도 표시 기능 추가
- 모바일/데스크탑 반응형 레이아웃 구현
- 로그인 페이지에 비밀번호 찾기 링크 추가
- 포괄적인 테스트 커버리지 (86개 테스트 모두 통과)

### File List

**신규 생성:**
- `app/auth/reset-password/page.tsx` - 비밀번호 찾기 페이지
- `app/auth/reset-password/page.test.tsx` - 비밀번호 찾기 페이지 테스트
- `app/auth/update-password/page.tsx` - 비밀번호 변경 페이지
- `app/auth/update-password/page.test.tsx` - 비밀번호 변경 페이지 테스트

**수정:**
- `app/auth/actions.ts` - requestPasswordReset, updatePassword 함수 추가
- `app/auth/actions.test.ts` - requestPasswordReset, updatePassword 테스트 추가
- `app/auth/login/page.tsx` - 비밀번호 찾기 링크 업데이트

**재사용:**
- `lib/validations/auth.ts` - validateEmail, validatePassword, validatePasswordMatch 함수
- `lib/supabase/server.ts` - Supabase 서버 클라이언트
- `components/ui/*` - Button, Input, Label, Card 컴포넌트

---

## QA Results

_[QA Agent가 작성]_

