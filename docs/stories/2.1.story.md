# Story 2.1: 노트 생성 (제목 + 본문)

## Status

Ready for Review

---

## Story

**As a** 로그인한 사용자,  
**I want** 제목과 본문을 입력하여 새로운 노트를 생성할 수 있기를,  
**so that** 내 생각과 아이디어를 빠르게 기록하고 저장할 수 있다.

---

## Acceptance Criteria

1. 로그인한 사용자만 노트 생성 페이지에 접근할 수 있다
2. 노트 생성 페이지는 `/notes/new` 경로에 존재한다
3. 제목 입력 필드가 제공되며, 최대 200자 제한이 있다
4. 본문 입력 필드(textarea)가 제공되며, 최대 50,000자 제한이 있다
5. 제목과 본문 모두 필수 입력 사항이다
6. 저장 버튼 클릭 시 노트가 데이터베이스에 저장된다
7. 저장 성공 시 노트 목록 페이지(`/notes`)로 리다이렉트된다
8. 저장 중 로딩 상태를 명확히 표시한다
9. 저장 실패 시 명확한 에러 메시지를 표시한다
10. 취소 버튼 클릭 시 노트 목록 페이지로 돌아간다
11. 페이지는 모바일/데스크탑 모두에서 정상 작동한다
12. 노트 생성 시 `created_at`과 `updated_at` 타임스탬프가 자동으로 설정된다

---

## Tasks / Subtasks

- [x] Task 1: 노트 생성 페이지 UI 구현 (AC: 2, 3, 4, 5, 10, 11)
  - [x] 페이지 라우트 생성 (`app/notes/new/page.tsx`)
  - [x] 제목 입력 필드 구현 (최대 200자)
  - [x] 본문 입력 필드(textarea) 구현 (최대 50,000자)
  - [x] 저장 버튼 및 취소 버튼 구현
  - [x] shadcn/ui 컴포넌트 활용 (Input, Textarea, Button, Card)
  - [x] Tailwind CSS를 사용한 반응형 레이아웃 구현
  - [x] 필드 유효성 검증 UI (실시간 글자 수 표시)

- [x] Task 2: 노트 생성 Server Action 구현 (AC: 6, 7, 8, 9, 12)
  - [x] Server Action 파일 생성 또는 기존 파일 확장 (`app/notes/actions.ts`)
  - [x] `createNote` Server Action 함수 구현
    - [x] 사용자 인증 확인 (Supabase Auth)
    - [x] 제목/본문 유효성 검증 (빈 값, 길이 제한)
    - [x] Drizzle ORM을 사용하여 노트 저장 (`lib/db/notes.ts`의 `createNote` 함수 활용)
    - [x] 사용자 ID 자동 설정 (현재 로그인 사용자)
    - [x] 성공 시 생성된 노트 ID 반환
    - [x] 실패 시 명확한 에러 메시지 반환
  - [x] 에러 핸들링 및 로깅

- [x] Task 3: 클라이언트 사이드 폼 로직 구현 (AC: 3, 4, 5, 8, 9, 10)
  - [x] React Hook Form 또는 Next.js form 액션 연동
  - [x] 실시간 글자 수 카운터 (제목 200자, 본문 50,000자)
  - [x] 필수 입력 검증 (제목, 본문)
  - [x] 제출 시 로딩 상태 관리
  - [x] 에러 상태 UI 업데이트
  - [x] 성공 시 리다이렉션 처리 (`/notes`)
  - [x] 취소 버튼 클릭 시 리다이렉션 처리 (`/notes`)

- [x] Task 4: 인증 미들웨어 적용 (AC: 1)
  - [x] 로그인하지 않은 사용자 접근 시 로그인 페이지로 리다이렉트
  - [x] Next.js 미들웨어 또는 페이지 레벨에서 인증 확인

- [x] Task 5: 테스트 작성 (AC: 전체)
  - [x] Server Action `createNote` 단위 테스트
    - [x] 성공 케이스: 정상 노트 생성
    - [x] 실패 케이스: 제목/본문 누락
    - [x] 실패 케이스: 글자 수 제한 초과
    - [x] 실패 케이스: 인증되지 않은 사용자
  - [x] UI 컴포넌트 렌더링 테스트
    - [x] 폼 요소 렌더링 확인
    - [x] 글자 수 카운터 동작 확인
    - [x] 저장/취소 버튼 동작 확인
  - [x] 통합 테스트
    - [x] 노트 생성 전체 플로우 테스트
    - [x] 에러 처리 테스트

---

## Dev Notes

### 기술 스택 및 아키텍처 컨텍스트

**프레임워크 및 라우팅**
- Next.js App Router 사용 (`/app` 디렉토리 구조)
- Server Actions로 서버 로직 구현
[Source: docs/architecture.md#1-기술-스택]

**데이터베이스 및 ORM**
- Drizzle ORM을 사용한 데이터 처리
- `lib/db/notes.ts`의 `createNote` 함수 활용
- Supabase Postgres 데이터베이스
[Source: docs/architecture.md#1-기술-스택, Story 2.0]

**인증 및 권한**
- Supabase Auth로 사용자 인증 확인
- 사용자 ID 스코프 적용 (notes.user_id)
- 로그인하지 않은 사용자 접근 차단
[Source: docs/architecture.md#3-보안]

**UI 컴포넌트 및 스타일링**
- shadcn/ui 컴포넌트 라이브러리 사용 (Input, Textarea, Button, Card 등)
- Tailwind CSS로 스타일링
[Source: docs/architecture.md#1-기술-스택]

**데이터 모델**
- notes 테이블: id, user_id, title, content, created_at, updated_at
- Story 2.0에서 이미 정의된 스키마 사용
[Source: docs/architecture.md#2-데이터-모델, Story 2.0]

### 이전 스토리에서의 주요 인사이트

**Story 2.0 (Drizzle ORM 셋업):**
- `lib/db/notes.ts`에 `createNote(userId, title, content)` 함수 이미 구현됨
- `lib/db/client.ts`에 Drizzle 클라이언트 설정 완료
- `drizzle/schema.ts`에 notes 테이블 스키마 정의 완료
- 사용자 ID 스코프 권한 적용 완료

**Story 1.x (사용자 인증):**
- `lib/supabase/server.ts`에 서버용 Supabase 클라이언트 구현됨
- 세션 확인 및 사용자 정보 가져오기 가능

### 파일 위치 및 구조

**새로 생성할 파일:**
- `/app/notes/new/page.tsx` - 노트 생성 페이지 (클라이언트 컴포넌트)
- `/app/notes/actions.ts` - 노트 관련 Server Actions
- `/app/notes/new/page.test.tsx` - 노트 생성 페이지 테스트
- `/app/notes/actions.test.ts` - Server Actions 테스트

**기존 파일 활용:**
- `/lib/db/notes.ts` - `createNote` 함수 사용
- `/lib/supabase/server.ts` - 사용자 인증 확인
- `/components/ui/*` - shadcn/ui 컴포넌트

### 구현 가이드라인

**노트 생성 Server Action 예시:**

```typescript
'use server';

import { createServerClient } from '@/lib/supabase/server';
import { createNote } from '@/lib/db/notes';
import { redirect } from 'next/navigation';

export async function createNoteAction(formData: FormData) {
  const supabase = createServerClient();
  
  // 사용자 인증 확인
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  
  if (authError || !user) {
    return { error: '인증되지 않은 사용자입니다.' };
  }
  
  // 폼 데이터 추출
  const title = formData.get('title') as string;
  const content = formData.get('content') as string;
  
  // 유효성 검증
  if (!title?.trim() || !content?.trim()) {
    return { error: '제목과 본문은 필수 입력 사항입니다.' };
  }
  
  if (title.length > 200) {
    return { error: '제목은 최대 200자까지 입력 가능합니다.' };
  }
  
  if (content.length > 50000) {
    return { error: '본문은 최대 50,000자까지 입력 가능합니다.' };
  }
  
  try {
    // 노트 생성
    const note = await createNote(user.id, title, content);
    
    // 성공 시 리다이렉트
    redirect('/notes');
  } catch (error) {
    console.error('노트 생성 에러:', error);
    return { error: '노트 저장 중 오류가 발생했습니다.' };
  }
}
```

**UI 컴포넌트 구현 가이드:**
- 제목 입력 필드: `<Input type="text" maxLength={200} />`
- 본문 입력 필드: `<Textarea maxLength={50000} rows={20} />`
- 글자 수 카운터: 실시간으로 입력한 글자 수 / 최대 글자 수 표시
- 저장 버튼: 로딩 중 비활성화 및 스피너 표시
- 취소 버튼: `router.push('/notes')` 또는 `<Link href="/notes">`

**에러 처리:**
- 제목/본문 누락: "제목과 본문은 필수 입력 사항입니다."
- 글자 수 초과: "제목은 최대 200자까지 입력 가능합니다." / "본문은 최대 50,000자까지 입력 가능합니다."
- 인증 에러: "로그인이 필요합니다."
- 네트워크 에러: "노트 저장 중 오류가 발생했습니다. 다시 시도해주세요."

**UX 고려사항:**
- 로딩 중 버튼 비활성화 및 스피너 표시
- 성공 시 즉시 노트 목록 페이지(`/notes`)로 리다이렉트
- 글자 수 카운터를 입력 필드 하단에 표시
- 에러 메시지는 필드 상단 또는 하단에 빨간색으로 표시
- 모바일에서도 편리하게 작성할 수 있도록 충분한 textarea 크기 제공

### 의존성

**선행 스토리:**
- Story 1.1, 1.2, 1.3 (사용자 인증) - 완료
- Story 2.0 (Drizzle ORM 셋업) - 완료

**후속 스토리:**
- Story 2.2: 노트 목록 조회 (노트 생성 후 목록에서 확인)

### Testing

**단위 테스트:**
- `createNoteAction` Server Action 테스트
  - 성공 케이스: 정상 노트 생성 → DB에 저장 확인
  - 실패 케이스: 제목 누락 → 에러 반환
  - 실패 케이스: 본문 누락 → 에러 반환
  - 실패 케이스: 글자 수 초과 → 에러 반환
  - 실패 케이스: 인증되지 않은 사용자 → 에러 반환

**컴포넌트 테스트:**
- 노트 생성 페이지 렌더링 테스트
  - 제목 입력 필드 렌더링 확인
  - 본문 입력 필드 렌더링 확인
  - 저장/취소 버튼 렌더링 확인
  - 글자 수 카운터 동작 확인

**통합 테스트:**
- 노트 생성 전체 플로우 테스트
  - 폼 입력 → 저장 → 리다이렉트 확인
  - 에러 발생 → 에러 메시지 표시 확인

**테스트 프레임워크:**
- Vitest + React Testing Library (이미 설정됨)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 2.1 초안 생성 | Bob (Scrum Master) |
| 2025-10-14 | 2.0 | 노트 생성 기능 구현 완료 - 모든 AC 충족, 16개 테스트 통과 | James (Developer) |
| 2025-10-14 | 2.1 | 브라우저 테스트 완료 - 실제 환경에서 모든 기능 동작 확인 | James (Developer) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- 테스트 실행 결과: 16개 테스트 모두 통과 (app/notes/actions.test.ts: 7개, app/notes/new/form.test.tsx: 9개)
- 전체 테스트 스위트: 114개 테스트 모두 통과 (회귀 테스트 포함)
- 브라우저 테스트: 실제 개발 서버(localhost:3000)에서 동작 확인 완료

### Completion Notes List

- 모든 Acceptance Criteria 충족:
  - AC 1: 페이지 레벨 인증 확인 구현 (로그인 안 한 사용자는 /auth/login으로 리다이렉트)
  - AC 2: `/notes/new` 경로에 노트 생성 페이지 생성
  - AC 3: 제목 입력 필드 구현 (최대 200자, 실시간 글자 수 카운터)
  - AC 4: 본문 입력 필드 구현 (최대 50,000자, 실시간 글자 수 카운터)
  - AC 5: 제목/본문 필수 입력 검증 구현
  - AC 6: Server Action을 통한 데이터베이스 저장 구현
  - AC 7: 저장 성공 시 `/notes`로 리다이렉트
  - AC 8: 로딩 중 상태 표시 (버튼 비활성화, "저장 중..." 텍스트)
  - AC 9: 에러 발생 시 명확한 에러 메시지 표시
  - AC 10: 취소 버튼 클릭 시 `/notes`로 이동
  - AC 11: Tailwind CSS 반응형 레이아웃 구현
  - AC 12: Drizzle ORM이 자동으로 created_at, updated_at 설정
- Server Component(page.tsx)와 Client Component(form.tsx) 분리 패턴 적용
- Textarea shadcn/ui 컴포넌트 신규 생성
- 노트 목록 페이지(/notes) 임시 placeholder 생성 (Story 2.2에서 완전 구현 예정)
- 포괄적인 테스트 커버리지: Server Action 7개 테스트, UI 컴포넌트 9개 테스트
- **브라우저 테스트 완료:** 실제 환경에서 모든 기능 동작 확인 (인증, 폼 입력, 유효성 검증, 저장, 리다이렉트)

### File List

**신규 생성:**
- `components/ui/textarea.tsx` - Textarea 컴포넌트 (shadcn/ui 스타일)
- `app/notes/actions.ts` - 노트 생성 Server Action
- `app/notes/actions.test.ts` - Server Action 테스트 (7개 테스트)
- `app/notes/new/page.tsx` - 노트 생성 페이지 (Server Component, 인증 확인)
- `app/notes/new/form.tsx` - 노트 생성 폼 (Client Component)
- `app/notes/new/form.test.tsx` - 폼 컴포넌트 테스트 (9개 테스트)
- `app/notes/page.tsx` - 노트 목록 페이지 (임시 placeholder)

**수정:**
- `docs/stories/2.1.story.md` - 스토리 상태 업데이트 및 Dev Agent Record 작성

---

## QA Results

_[QA Agent가 작성]_

