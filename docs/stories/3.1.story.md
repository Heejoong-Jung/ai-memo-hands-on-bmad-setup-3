# Story 3.1: 음성인식 시스템 초기 설정

## Status

Draft

---

## Story

**As a** 사용자,  
**I want** 음성인식 기능을 사용하기 전에 시스템이 올바르게 설정되고 권한이 관리되어,  
**so that** 안정적이고 신뢰할 수 있는 음성인식 환경에서 메모를 작성할 수 있다.

---

## Acceptance Criteria

1. Web Speech API 지원 여부를 브라우저별로 검사할 수 있어야 한다
2. Chrome, Safari, Firefox 브라우저별 호환성 상태를 확인할 수 있어야 한다
3. STT 미지원 브라우저에서는 적절한 대체 UI를 제공해야 한다
4. 마이크 권한 상태를 실시간으로 확인하고 관리할 수 있어야 한다
5. 마이크 권한 요청 시 사용자에게 명확한 안내를 제공해야 한다
6. 권한이 거부된 경우 대체 방안을 제시해야 한다
7. Web Speech API 초기화 시 에러 핸들링이 구현되어야 한다
8. 한국어(ko-KR) 언어 설정이 기본값으로 설정되어야 한다
9. 모든 기능에 대한 단위 테스트 및 통합 테스트를 작성해야 한다

---

## Tasks / Subtasks

- [ ] Task 1: Web Speech API 호환성 검사 시스템 구현 (AC: 1, 2, 3)
  - [ ] `lib/speech/speech-utils.ts` 파일 생성
  - [ ] `checkSpeechRecognitionSupport` 함수 구현
  - [ ] 브라우저별 지원 여부 검사 (Chrome, Safari, Firefox)
  - [ ] 호환성 상태 반환 (supported, unsupported, partial)
  - [ ] 브라우저별 가이드 메시지 제공
  - [ ] 단위 테스트 작성

- [ ] Task 2: 브라우저 호환성 UI 컴포넌트 구현 (AC: 3)
  - [ ] `components/speech/browser-compatibility.tsx` 컴포넌트 생성
  - [ ] 지원/미지원 브라우저별 메시지 표시
  - [ ] 대체 UI 제공 (텍스트 입력 안내)
  - [ ] 브라우저 업그레이드 권장 메시지
  - [ ] 시각적 상태 표시 (아이콘, 색상)
  - [ ] 컴포넌트 테스트 작성

- [ ] Task 3: 마이크 권한 관리 시스템 구현 (AC: 4, 5, 6)
  - [ ] `lib/speech/permission-manager.ts` 파일 생성
  - [ ] 권한 상태 추적 및 관리 클래스 구현
  - [ ] 브라우저별 권한 API 차이점 처리
  - [ ] 권한 상태 변경 이벤트 리스너 구현
  - [ ] 권한 요청 및 거부 처리
  - [ ] 단위 테스트 작성

- [ ] Task 4: 마이크 권한 UI 컴포넌트 구현 (AC: 5, 6)
  - [ ] `components/speech/microphone-permission.tsx` 컴포넌트 생성
  - [ ] 권한 요청 버튼 및 상태 표시
  - [ ] 권한 상태별 시각적 피드백 (아이콘, 색상)
  - [ ] 로딩 상태 및 진행 상황 표시
  - [ ] 권한 거부 시 대체 방안 안내
  - [ ] 컴포넌트 테스트 작성

- [ ] Task 5: Web Speech API 초기화 및 설정 (AC: 7, 8)
  - [ ] `lib/speech/speech-recognition.ts` 파일 생성
  - [ ] SpeechRecognition 인스턴스 생성 함수
  - [ ] 한국어(ko-KR) 기본 설정
  - [ ] 에러 핸들링 및 예외 처리
  - [ ] 초기화 상태 관리
  - [ ] 단위 테스트 작성

- [ ] Task 6: 통합 테스트 및 사용성 검증 (AC: 9)
  - [ ] 다양한 브라우저에서 호환성 테스트
  - [ ] 마이크 권한 시나리오 테스트
  - [ ] 에러 상황 시뮬레이션 테스트
  - [ ] 사용자 경험 플로우 테스트

---

## Dev Notes

### 기술 스택 및 아키텍처 컨텍스트

**Web Speech API**
- SpeechRecognition API 사용 (Web Speech API)
- 브라우저 지원: Chrome 25+, Safari 14.1+, Firefox 미지원
- 언어 설정: 한국어 (ko-KR) 기본값
- 실시간 음성-텍스트 변환
[Source: docs/epics/epic-3-voice-memo.md]

**브라우저 호환성**
- Chrome: 완전 지원 (SpeechRecognition)
- Safari: 부분 지원 (webkitSpeechRecognition)
- Firefox: 미지원 (대체 UI 제공)
- 모바일: iOS Safari, Android Chrome 지원
[Source: docs/epics/epic-3-voice-memo.md]

**권한 관리**
- navigator.permissions.query() API 사용
- navigator.mediaDevices.getUserMedia() 권한 요청
- 권한 상태: granted, denied, prompt
- 브라우저별 권한 관리 차이점 처리
[Source: docs/epics/epic-3-voice-memo.md]

### Epic 컨텍스트

**Epic 3: 음성인식 메모 작성**
- 음성인식 정확도 95% 이상 목표
- 음성-텍스트 변환 지연시간 2초 이내
- 음성 기능 관련 에러율 3% 미만
- 접근성 향상을 통한 사용자층 확대
[Source: docs/epics/epic-3-voice-memo.md]

### 이전 스토리에서의 주요 인사이트

**Story 2.x: 노트 관리 시스템 완료**
- `app/notes/actions.ts`: Server Actions 패턴
- `lib/db/notes.ts`: CRUD 함수 패턴
- 사용자 인증 확인: `supabase.auth.getUser()`
- 에러 핸들링: try-catch 및 사용자 친화적 에러 메시지
- shadcn/ui 컴포넌트 활용한 UI 구현
[Source: app/notes/actions.ts, lib/db/notes.ts]

### 파일 위치 및 구조

**새로 생성할 파일:**
- `lib/speech/speech-utils.ts` - Web Speech API 호환성 검사
- `lib/speech/permission-manager.ts` - 마이크 권한 상태 관리
- `lib/speech/speech-recognition.ts` - SpeechRecognition 초기화 및 설정
- `components/speech/browser-compatibility.tsx` - 브라우저 호환성 UI
- `components/speech/microphone-permission.tsx` - 마이크 권한 UI
- `lib/speech/speech-utils.test.ts` - 호환성 검사 테스트
- `lib/speech/permission-manager.test.ts` - 권한 관리 테스트
- `lib/speech/speech-recognition.test.ts` - SpeechRecognition 테스트
- `components/speech/browser-compatibility.test.tsx` - 호환성 UI 테스트
- `components/speech/microphone-permission.test.tsx` - 권한 UI 테스트

### 구현 가이드라인

**Web Speech API 호환성 검사 예시:**

```typescript
// lib/speech/speech-utils.ts
// Web Speech API 호환성 검사 유틸리티
// 브라우저별 SpeechRecognition 지원 여부 확인
// 관련 파일: components/speech/browser-compatibility.tsx, lib/speech/speech-recognition.ts

export type BrowserSupport = 'supported' | 'unsupported' | 'partial';

export interface SpeechSupportInfo {
  isSupported: boolean;
  browserSupport: BrowserSupport;
  userAgent: string;
  hasWebkitPrefix: boolean;
  errorMessage?: string;
}

/**
 * Web Speech API 지원 여부 검사
 */
export function checkSpeechRecognitionSupport(): SpeechSupportInfo {
  const userAgent = navigator.userAgent;
  
  // Chrome 지원 확인
  if ('SpeechRecognition' in window) {
    return {
      isSupported: true,
      browserSupport: 'supported',
      userAgent,
      hasWebkitPrefix: false,
    };
  }
  
  // Safari 지원 확인 (webkit prefix)
  if ('webkitSpeechRecognition' in window) {
    return {
      isSupported: true,
      browserSupport: 'partial',
      userAgent,
      hasWebkitPrefix: true,
    };
  }
  
  // Firefox 및 기타 미지원 브라우저
  return {
    isSupported: false,
    browserSupport: 'unsupported',
    userAgent,
    hasWebkitPrefix: false,
    errorMessage: '이 브라우저는 음성인식을 지원하지 않습니다.',
  };
}

/**
 * 브라우저별 지원 상태 메시지
 */
export function getBrowserSupportMessage(supportInfo: SpeechSupportInfo): string {
  switch (supportInfo.browserSupport) {
    case 'supported':
      return '음성인식 기능을 사용할 수 있습니다.';
    case 'partial':
      return '음성인식 기능을 제한적으로 사용할 수 있습니다.';
    case 'unsupported':
      return '이 브라우저는 음성인식을 지원하지 않습니다. Chrome 또는 Safari를 사용해주세요.';
    default:
      return '브라우저 호환성을 확인할 수 없습니다.';
  }
}
```

**마이크 권한 관리 시스템 예시:**

```typescript
// lib/speech/permission-manager.ts
// 마이크 권한 상태 관리 및 실시간 업데이트
// 브라우저별 권한 API 차이점 처리
// 관련 파일: components/speech/microphone-permission.tsx, lib/speech/speech-recognition.ts

export type PermissionState = 'granted' | 'denied' | 'prompt' | 'unknown';
export type PermissionRequestState = 'idle' | 'requesting' | 'success' | 'error';

export interface PermissionInfo {
  state: PermissionState;
  canRequest: boolean;
  message: string;
  browserGuide?: string;
}

export class MicrophonePermissionManager {
  private permissionState: PermissionState = 'unknown';
  private requestState: PermissionRequestState = 'idle';
  private listeners: Set<(state: PermissionState) => void> = new Set();
  private permissionQuery: PermissionStatus | null = null;

  constructor() {
    this.initializePermissionListener();
  }

  /**
   * 권한 상태 초기화 및 리스너 설정
   */
  private async initializePermissionListener(): Promise<void> {
    try {
      if (navigator.permissions) {
        this.permissionQuery = await navigator.permissions.query({ name: 'microphone' as PermissionName });
        this.permissionQuery.addEventListener('change', this.handlePermissionChange.bind(this));
        this.updatePermissionState(this.permissionQuery.state as PermissionState);
      } else {
        // Safari 등 navigator.permissions 미지원 브라우저
        this.updatePermissionState('prompt');
      }
    } catch (error) {
      console.warn('권한 상태 초기화 실패:', error);
      this.updatePermissionState('prompt');
    }
  }

  /**
   * 권한 상태 변경 처리
   */
  private handlePermissionChange(): void {
    if (this.permissionQuery) {
      this.updatePermissionState(this.permissionQuery.state as PermissionState);
    }
  }

  /**
   * 권한 상태 업데이트 및 리스너 알림
   */
  private updatePermissionState(newState: PermissionState): void {
    if (this.permissionState !== newState) {
      this.permissionState = newState;
      this.notifyListeners();
    }
  }

  /**
   * 권한 상태 변경 리스너 등록
   */
  addStateChangeListener(listener: (state: PermissionState) => void): () => void {
    this.listeners.add(listener);
    return () => this.listeners.delete(listener);
  }

  /**
   * 리스너들에게 상태 변경 알림
   */
  private notifyListeners(): void {
    this.listeners.forEach(listener => listener(this.permissionState));
  }

  /**
   * 현재 권한 상태 반환
   */
  getPermissionState(): PermissionState {
    return this.permissionState;
  }

  /**
   * 현재 요청 상태 반환
   */
  getRequestState(): PermissionRequestState {
    return this.requestState;
  }

  /**
   * 권한 정보 조회
   */
  getPermissionInfo(): PermissionInfo {
    switch (this.permissionState) {
      case 'granted':
        return {
          state: 'granted',
          canRequest: false,
          message: '마이크 권한이 허용되었습니다.',
        };
      case 'denied':
        return {
          state: 'denied',
          canRequest: false,
          message: '마이크 권한이 거부되었습니다.',
          browserGuide: this.getBrowserGuide(),
        };
      case 'prompt':
        return {
          state: 'prompt',
          canRequest: true,
          message: '마이크 권한을 요청할 수 있습니다.',
        };
      default:
        return {
          state: 'unknown',
          canRequest: true,
          message: '마이크 권한 상태를 확인할 수 없습니다.',
        };
    }
  }

  /**
   * 마이크 권한 요청
   */
  async requestPermission(): Promise<boolean> {
    if (this.requestState === 'requesting') {
      return false;
    }

    this.requestState = 'requesting';
    this.notifyListeners();

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      
      // 권한 확인 후 스트림 종료
      stream.getTracks().forEach(track => track.stop());
      
      this.requestState = 'success';
      this.updatePermissionState('granted');
      return true;
    } catch (error) {
      console.error('마이크 권한 요청 실패:', error);
      this.requestState = 'error';
      this.updatePermissionState('denied');
      return false;
    }
  }

  /**
   * 브라우저별 권한 설정 가이드
   */
  private getBrowserGuide(): string {
    const userAgent = navigator.userAgent;
    
    if (userAgent.includes('Chrome')) {
      return 'Chrome: 주소창 왼쪽의 자물쇠 아이콘을 클릭하여 마이크 권한을 허용해주세요.';
    } else if (userAgent.includes('Safari')) {
      return 'Safari: Safari > 환경설정 > 웹사이트 > 마이크에서 권한을 허용해주세요.';
    } else if (userAgent.includes('Firefox')) {
      return 'Firefox: 주소창 왼쪽의 자물쇠 아이콘을 클릭하여 마이크 권한을 허용해주세요.';
    } else {
      return '브라우저 설정에서 마이크 권한을 허용해주세요.';
    }
  }

  /**
   * 리소스 정리
   */
  destroy(): void {
    if (this.permissionQuery) {
      this.permissionQuery.removeEventListener('change', this.handlePermissionChange.bind(this));
    }
    this.listeners.clear();
  }
}
```

**SpeechRecognition 초기화 예시:**

```typescript
// lib/speech/speech-recognition.ts
// Web Speech API SpeechRecognition 초기화 및 설정
// 한국어 음성인식 기본 설정 및 에러 핸들링
// 관련 파일: lib/speech/speech-utils.ts, app/notes/new/form.tsx

import { checkSpeechRecognitionSupport } from './speech-utils';

export interface SpeechRecognitionConfig {
  language: string;
  continuous: boolean;
  interimResults: boolean;
  maxAlternatives: number;
}

export class SpeechRecognitionManager {
  private recognition: SpeechRecognition | webkitSpeechRecognition | null = null;
  private config: SpeechRecognitionConfig;

  constructor(config: Partial<SpeechRecognitionConfig> = {}) {
    this.config = {
      language: 'ko-KR',
      continuous: true,
      interimResults: true,
      maxAlternatives: 1,
      ...config,
    };
  }

  /**
   * SpeechRecognition 인스턴스 초기화
   */
  initialize(): Promise<void> {
    return new Promise((resolve, reject) => {
      const supportInfo = checkSpeechRecognitionSupport();
      
      if (!supportInfo.isSupported) {
        reject(new Error(supportInfo.errorMessage || 'SpeechRecognition을 지원하지 않습니다.'));
        return;
      }

      try {
        // 브라우저별 SpeechRecognition 인스턴스 생성
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();

        // 설정 적용
        this.recognition.lang = this.config.language;
        this.recognition.continuous = this.config.continuous;
        this.recognition.interimResults = this.config.interimResults;
        this.recognition.maxAlternatives = this.config.maxAlternatives;

        resolve();
      } catch (error) {
        reject(new Error('SpeechRecognition 초기화에 실패했습니다.'));
      }
    });
  }

  /**
   * SpeechRecognition 인스턴스 반환
   */
  getRecognition(): SpeechRecognition | webkitSpeechRecognition | null {
    return this.recognition;
  }
}
```

### 의존성

**선행 스토리:**
- Story 2.x: 노트 관리 시스템 (완료) - 노트 생성/수정 기능 활용

**후속 스토리:**
- Story 3.2: 실시간 음성-텍스트 변환

**블로킹 없음:**
- 이 스토리는 독립적으로 구현 가능
- 브라우저 API만 사용하므로 외부 의존성 없음

### Testing

**테스트 프레임워크:**
- Vitest + TypeScript
- jsdom 환경에서 브라우저 API 모킹

**단위 테스트:**
- `checkSpeechRecognitionSupport` 함수 테스트
  - Chrome 환경 모킹 (SpeechRecognition 지원)
  - Safari 환경 모킹 (webkitSpeechRecognition 지원)
  - Firefox 환경 모킹 (미지원)
  - Edge 환경 모킹 (미지원)
- `MicrophonePermissionManager` 클래스 테스트
  - 권한 상태 초기화 확인
  - 권한 상태 변경 감지 확인
  - 권한 요청 성공/실패 확인
  - 리스너 등록/해제 확인
- `SpeechRecognitionManager` 클래스 테스트
  - 정상 초기화 확인
  - 설정값 적용 확인
  - 미지원 브라우저 에러 처리

**통합 테스트:**
- 브라우저 호환성 UI 렌더링 테스트
- 마이크 권한 요청 플로우 테스트
- 에러 상황 UI 표시 테스트

**모킹 전략:**
- `window.SpeechRecognition` 모킹
- `window.webkitSpeechRecognition` 모킹
- `navigator.permissions` 모킹
- `navigator.mediaDevices.getUserMedia` 모킹

**테스트 케이스:**
1. **브라우저 호환성 검사**
   - Chrome: SpeechRecognition 지원 확인
   - Safari: webkitSpeechRecognition 지원 확인
   - Firefox: 미지원 확인
   - Edge: 미지원 확인

2. **마이크 권한 관리**
   - 권한 허용 상태 확인
   - 권한 거부 상태 확인
   - 권한 요청 성공/실패
   - 권한 상태 변경 감지

3. **SpeechRecognition 초기화**
   - 정상 초기화 성공
   - 설정값 적용 확인
   - 미지원 브라우저 에러 처리

4. **UI 컴포넌트**
   - 지원 브라우저 UI 표시
   - 미지원 브라우저 UI 표시
   - 권한 상태별 UI 표시
   - 로딩 상태 표시

**테스트 실행:**
- `pnpm test` - 전체 테스트 suite 실행
- `pnpm test lib/speech` - Speech 관련 테스트만 실행
- `pnpm test components/speech` - Speech UI 테스트만 실행

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story 3.1 통합 버전 생성 | Bob (Scrum Master) |

---

## Dev Agent Record

_[Dev Agent가 구현 시 작성]_

---

## QA Results

_[QA Agent가 작성]_
