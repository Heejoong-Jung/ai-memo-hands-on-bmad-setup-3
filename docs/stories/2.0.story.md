# Story 2.0: Drizzle ORM 셋업 및 노트 스키마 정의

## Status

Ready for Review

---

## Story

**As a** 개발팀,  
**I want** Drizzle ORM을 설치하고 노트 테이블 스키마를 정의할 수 있기를,  
**so that** 노트 관리 시스템의 데이터 모델링 기반을 구축하고 안정적인 CRUD 작업을 수행할 수 있다.

---

## Acceptance Criteria

1. Drizzle ORM 및 관련 의존성이 설치되어 있다
2. Drizzle 설정 파일(`drizzle.config.ts`)이 프로젝트 루트에 존재한다
3. 노트 스키마(`drizzle/schema.ts`)가 정의되어 있다
4. 노트 테이블에는 id, user_id, title, content, created_at, updated_at 필드가 포함된다
5. 마이그레이션 파일이 생성되고 데이터베이스에 적용된다
6. 스키마가 Supabase Postgres 데이터베이스에 정상적으로 반영된다
7. 기본 CRUD 유틸리티 함수가 작성되어 있다 (create, read, update, delete)
8. 모든 CRUD 함수에 사용자 ID 스코프 권한이 적용되어 있다
9. CRUD 함수에 대한 단위 테스트가 작성되고 모두 통과한다
10. TypeScript 타입이 자동 생성되고 타입 안전성이 보장된다

---

## Tasks / Subtasks

- [x] Task 1: Drizzle ORM 패키지 설치 및 설정 (AC: 1, 2)
  - [x] Drizzle ORM 및 PostgreSQL 어댑터 설치 (`pnpm add drizzle-orm postgres`)
  - [x] Drizzle Kit 설치 (`pnpm add -D drizzle-kit`)
  - [x] `drizzle.config.ts` 설정 파일 생성 (Supabase 연결 정보 포함)
  - [x] 환경 변수 확인 및 설정 (DATABASE_URL)
  - [x] `.gitignore`에 드리즐 생성 파일 추가 (`drizzle/migrations/*`)

- [x] Task 2: 노트 스키마 정의 (AC: 3, 4, 10)
  - [x] `drizzle` 디렉토리 생성
  - [x] `drizzle/schema.ts` 파일 생성
  - [x] `notes` 테이블 스키마 정의
    - [x] id (uuid, primary key, default: gen_random_uuid())
    - [x] user_id (uuid, not null, references auth.users)
    - [x] title (text, not null)
    - [x] content (text, not null)
    - [x] created_at (timestamp, default: now())
    - [x] updated_at (timestamp, default: now())
  - [x] 인덱스 정의 (user_id, created_at)
  - [x] TypeScript 타입 export

- [ ] Task 3: 마이그레이션 파일 생성 및 적용 (AC: 5, 6) - 사용자가 수동으로 실행 필요
  - [ ] `pnpm drizzle-kit generate` 실행하여 마이그레이션 파일 생성 (DATABASE_URL 필요)
  - [ ] 생성된 마이그레이션 파일 검토
  - [ ] `pnpm drizzle-kit push` 실행하여 스키마를 DB에 반영
  - [ ] Supabase Dashboard에서 테이블 생성 확인
  - [ ] 테이블 구조 및 제약조건 검증

- [x] Task 4: 기본 CRUD 유틸리티 함수 작성 (AC: 7, 8)
  - [x] `lib/db` 디렉토리 생성
  - [x] `lib/db/notes.ts` 파일 생성
  - [x] Drizzle 클라이언트 설정 (`lib/db/client.ts`)
  - [x] `createNote(userId, title, content)` 함수 작성
  - [x] `getNotesByUserId(userId)` 함수 작성 (사용자 스코프 적용)
  - [x] `getNoteById(noteId, userId)` 함수 작성 (사용자 스코프 적용)
  - [x] `updateNote(noteId, userId, title, content)` 함수 작성 (사용자 스코프 적용)
  - [x] `deleteNote(noteId, userId)` 함수 작성 (사용자 스코프 적용)
  - [x] 에러 처리 및 타입 안정성 보장

- [x] Task 5: CRUD 함수 테스트 작성 (AC: 9)
  - [x] `lib/db/notes.test.ts` 파일 생성
  - [x] 테스트 데이터베이스 설정 (또는 모킹)
  - [x] createNote 함수 테스트
    - [x] 성공 케이스: 노트 생성 성공
    - [x] 실패 케이스: 필수 필드 누락
  - [x] getNotesByUserId 함수 테스트
    - [x] 성공 케이스: 사용자 노트 목록 조회
    - [x] 빈 목록 케이스: 노트가 없는 경우
    - [x] 권한 체크: 다른 사용자의 노트는 조회되지 않음
  - [x] getNoteById 함수 테스트
    - [x] 성공 케이스: 특정 노트 조회
    - [x] 실패 케이스: 존재하지 않는 노트
    - [x] 권한 체크: 다른 사용자의 노트 접근 차단
  - [x] updateNote 함수 테스트
    - [x] 성공 케이스: 노트 수정 성공
    - [x] 실패 케이스: 존재하지 않는 노트
    - [x] 권한 체크: 다른 사용자의 노트 수정 차단
  - [x] deleteNote 함수 테스트
    - [x] 성공 케이스: 노트 삭제 성공
    - [x] 실패 케이스: 존재하지 않는 노트
    - [x] 권한 체크: 다른 사용자의 노트 삭제 차단
  - [x] 모든 테스트 실행 및 통과 확인 (`pnpm test`)

- [x] Task 6: 문서화 및 검증 (AC: 10)
  - [x] README에 Drizzle 명령어 사용법 추가 (이미 존재하므로 확인)
  - [x] TypeScript 컴파일 확인 (`pnpm tsc --noEmit`) - 신규 파일 린트 에러 없음
  - [x] 린터 실행 및 오류 수정 (`pnpm lint`) - 신규 파일 린트 에러 없음
  - [x] 전체 테스트 suite 실행 확인 - 12개 테스트 모두 통과

---

## Dev Notes

### 기술 스택 및 아키텍처 컨텍스트

**ORM 및 데이터베이스**
- ORM: Drizzle ORM (마이그레이션/쿼리)
- 데이터베이스: Supabase Postgres
- Drizzle Kit을 사용한 마이그레이션 관리
[Source: docs/architecture.md#1-기술-스택]

**데이터 모델**
- **notes 테이블 구조:**
  - id (Primary Key)
  - user_id (Foreign Key → auth.users)
  - title (텍스트, 필수)
  - content (텍스트, 필수)
  - created_at (타임스탬프)
  - updated_at (타임스탬프)
- 향후 추가 예정: note_tags, summaries 테이블 (에픽 4, 5에서 구현)
[Source: docs/architecture.md#2-데이터-모델]

**보안 및 권한**
- **권한 스코프:**
  - Notes: 사용자 ID 스코프로 소유자만 CRUD 가능
  - 모든 쿼리에 WHERE user_id = ? 조건 필수
  - Supabase 서비스 롤 키는 서버 전용
[Source: docs/architecture.md#3-보안]

**배포 및 운영**
- Drizzle Kit으로 마이그레이션 관리
- Vercel Preview 브랜치 기반 배포
- Supabase 모니터링
[Source: docs/architecture.md#6-배포/운영]

### 이전 스토리(1.1, 1.2, 1.3)에서의 주요 인사이트

- Supabase 클라이언트 및 서버 유틸리티 이미 구현됨:
  - `lib/supabase/client.ts` (브라우저용)
  - `lib/supabase/server.ts` (서버용)
- 환경 변수 설정 완료 (`.env.local`)
- Vitest + React Testing Library 테스트 환경 설정 완료
- 사용자 인증 시스템 완료 (Epic 1)

### 파일 위치 및 구조

**새로 생성할 파일:**
- `/drizzle.config.ts` - Drizzle 설정 파일 (프로젝트 루트)
- `/drizzle/schema.ts` - 노트 테이블 스키마 정의
- `/drizzle/migrations/` - 마이그레이션 파일 디렉토리 (자동 생성)
- `/lib/db/client.ts` - Drizzle 클라이언트 설정
- `/lib/db/notes.ts` - 노트 CRUD 유틸리티 함수
- `/lib/db/notes.test.ts` - CRUD 함수 테스트

**환경 변수:**
- `DATABASE_URL` - Supabase Postgres 연결 문자열 (`.env.local`에 추가)

### 구현 가이드라인

**Drizzle 설정 예시 (`drizzle.config.ts`):**

```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './drizzle/schema.ts',
  out: './drizzle/migrations',
  driver: 'pg',
  dbCredentials: {
    connectionString: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

**스키마 정의 예시 (`drizzle/schema.ts`):**

```typescript
import { pgTable, uuid, text, timestamp } from 'drizzle-orm/pg-core';

export const notes = pgTable('notes', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => auth.users.id),
  title: text('title').notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export type Note = typeof notes.$inferSelect;
export type NewNote = typeof notes.$inferInsert;
```

**CRUD 함수 권한 스코프 적용 예시:**

```typescript
// 사용자 스코프 적용 - 반드시 userId로 필터링
export async function getNotesByUserId(userId: string) {
  return db.select().from(notes).where(eq(notes.userId, userId));
}

export async function getNoteById(noteId: string, userId: string) {
  const result = await db
    .select()
    .from(notes)
    .where(and(eq(notes.id, noteId), eq(notes.userId, userId)))
    .limit(1);
  return result[0] || null;
}
```

**마이그레이션 명령어:**
- 마이그레이션 파일 생성: `pnpm drizzle-kit generate`
- 마이그레이션 적용: `pnpm drizzle-kit push`
- DB 스키마 가져오기: `pnpm drizzle-kit pull`
- Drizzle Studio 실행: `pnpm drizzle-kit studio`

**에러 처리:**
- 존재하지 않는 노트 접근: null 반환 또는 명시적 에러
- 권한 없는 접근: null 반환 (다른 사용자의 노트는 조회되지 않음)
- 데이터베이스 연결 에러: 적절한 에러 메시지와 함께 throw

**테스트 전략:**
- 단위 테스트: 각 CRUD 함수별 성공/실패 케이스
- 권한 테스트: 사용자 스코프 적용 확인 (다른 사용자 데이터 접근 차단)
- 데이터베이스 모킹 또는 테스트 데이터베이스 사용
- Vitest의 `vi.mock`을 사용한 Drizzle 클라이언트 모킹

### Testing

**테스트 프레임워크:**
- Vitest (이미 설정됨)
- 데이터베이스 모킹 또는 테스트 환경 구성

**단위 테스트:**
- `lib/db/notes.test.ts`에 모든 CRUD 함수 테스트 작성
- 각 함수별 성공 케이스, 실패 케이스, 권한 체크 케이스

**테스트 케이스:**
1. **createNote**
   - 성공: 올바른 데이터로 노트 생성
   - 실패: 필수 필드 누락 (title, content)
   
2. **getNotesByUserId**
   - 성공: 사용자의 모든 노트 조회
   - 빈 목록: 노트가 없는 경우
   - 권한: 다른 사용자의 노트는 포함되지 않음

3. **getNoteById**
   - 성공: 특정 노트 조회
   - 실패: 존재하지 않는 노트 ID
   - 권한: 다른 사용자의 노트 접근 시 null 반환

4. **updateNote**
   - 성공: 노트 수정 (title, content, updated_at 갱신)
   - 실패: 존재하지 않는 노트
   - 권한: 다른 사용자의 노트 수정 시도 차단

5. **deleteNote**
   - 성공: 노트 삭제
   - 실패: 존재하지 않는 노트
   - 권한: 다른 사용자의 노트 삭제 시도 차단

**테스트 실행:**
- `pnpm test` - 전체 테스트 suite 실행
- `pnpm test lib/db/notes.test.ts` - 특정 파일 테스트

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 2.0 초안 생성 | Bob (Scrum Master) |
| 2025-10-14 | 2.0 | Drizzle ORM 셋업 완료 - 스키마, CRUD 함수, 테스트 구현 | James (Developer) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- 테스트 실행 결과: 12개 테스트 모두 통과 (lib/db/notes.test.ts)
- 린터 검증: 신규 파일 모두 에러 없음
- TypeScript 컴파일: 신규 파일 타입 에러 없음

### Completion Notes List

- Drizzle ORM 설정 완료 (drizzle.config.ts)
- Notes 테이블 스키마 정의 완료 (id, user_id, title, content, timestamps)
- 사용자 ID 기반 인덱스 추가 (성능 최적화)
- 5개 CRUD 함수 구현 완료 (createNote, getNotesByUserId, getNoteById, updateNote, deleteNote)
- 모든 CRUD 함수에 사용자 스코프 권한 적용 (보안)
- 포괄적인 테스트 커버리지 (12개 테스트: 성공/실패/권한 케이스)
- Task 3 (마이그레이션 적용)은 사용자가 DATABASE_URL 설정 후 수동 실행 필요

### File List

**신규 생성:**
- `drizzle.config.ts` - Drizzle Kit 설정 파일
- `drizzle/schema.ts` - Notes 테이블 스키마 정의
- `lib/db/client.ts` - Drizzle ORM 클라이언트 설정
- `lib/db/notes.ts` - Notes CRUD 유틸리티 함수
- `lib/db/notes.test.ts` - Notes CRUD 함수 테스트 (12개 테스트)

**수정:**
- `.gitignore` - drizzle/migrations/* 추가

**디렉토리 생성:**
- `drizzle/` - 스키마 및 마이그레이션 디렉토리
- `lib/db/` - 데이터베이스 유틸리티 디렉토리

---

## QA Results

_[QA Agent가 작성]_

